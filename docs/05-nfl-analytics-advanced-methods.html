<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>An Introduction to NFL Analytics with R - 6&nbsp; Advanced Methods: Modeling and Big Data Bowl</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./04-nfl-analytics-visualization.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-0ZLEFZL898"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-0ZLEFZL898', { 'anonymize_ip': true});
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">
<span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Advanced Methods: Modeling and Big Data Bowl</span>
</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">An Introduction to NFL Analytics with R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/bcongelio/nfl-analytics-with-r-book" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
<li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-nfl-analytics-and-r.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">An Introduction to NFL Analytics and the R Programming Language</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-nfl-analytics-tidyverse.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling NFL Data in the <code>tidyverse</code></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-nfl-analytics-functions.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">NFL Analytics with the <code>nflverse</code> Family of Packages</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-nfl-analytics-visualization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Data Visualization with NFL Analytics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-nfl-analytics-advanced-methods.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Advanced Methods: Modeling and Big Data Bowl</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Appendices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a1-nfl-analytics-dictionary.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">NFL Analytics Reference Guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a2-nfl-further-reading.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Further Reading Suggestions</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#exploring-rushing-yards-over-expected" id="toc-exploring-rushing-yards-over-expected" class="nav-link active" data-scroll-target="#exploring-rushing-yards-over-expected"><span class="toc-section-number">6.1</span>  Exploring Rushing Yards Over Expected</a>
  <ul class="collapse">
<li><a href="#tej-seths-ryoe-model-under-the-hood" id="toc-tej-seths-ryoe-model-under-the-hood" class="nav-link" data-scroll-target="#tej-seths-ryoe-model-under-the-hood"><span class="toc-section-number">6.1.1</span>  Tej Seth’s RYOE Model: Under The Hood</a></li>
  <li><a href="#extreme-gradient-boosting-explained" id="toc-extreme-gradient-boosting-explained" class="nav-link" data-scroll-target="#extreme-gradient-boosting-explained"><span class="toc-section-number">6.1.2</span>  eXtreme Gradient Boosting Explained</a></li>
  <li><a href="#building-ryoe-with-xgboost" id="toc-building-ryoe-with-xgboost" class="nav-link" data-scroll-target="#building-ryoe-with-xgboost"><span class="toc-section-number">6.1.3</span>  Building RYOE with <code>xgboost</code></a></li>
  </ul>
</li>
  <li><a href="#building-a-ryoe-model-with-xgboost-in-tidymodels" id="toc-building-a-ryoe-model-with-xgboost-in-tidymodels" class="nav-link" data-scroll-target="#building-a-ryoe-model-with-xgboost-in-tidymodels"><span class="toc-section-number">6.2</span>  Building a RYOE Model with XGBoost in <code>tidymodels</code></a></li>
  <li><a href="#navigating-the-nfls-big-data-bowl" id="toc-navigating-the-nfls-big-data-bowl" class="nav-link" data-scroll-target="#navigating-the-nfls-big-data-bowl"><span class="toc-section-number">6.3</span>  Navigating the NFL’s Big Data Bowl</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title d-none d-lg-block">
<span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Advanced Methods: Modeling and Big Data Bowl</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>introduction coming to this location soon.</p>
<section id="exploring-rushing-yards-over-expected" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="exploring-rushing-yards-over-expected">
<span class="header-section-number">6.1</span> Exploring Rushing Yards Over Expected</h2>
<p>Back in January of 2021, Tej Seth posted an article to the <a href="https://mfootballanalytics.com/2021/01/14/creating-a-public-expected-rushing-yards-model/">Michigan Football Analytics Society blog</a> that outlined his vision for creating a “public expected rushing yards model.” The structure of his model, as explained by Tej, was inspired by the prior work of Michael Egle, an honorable mention in both the 2021 and 2023 NFL Big Data Bowl, who previously used the college football equivalent of open-source data (<a href="https://cfbfastr.sportsdataverse.org/"><code>cfbfastR</code></a>) to create an RYOE model for the collegiate game.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> In Tej’s case, his approach to created an NFL-centric RYOE model culminated with the creation of his <a href="https://mfbanalytics.shinyapps.io/RYOE/">RYOE Shiny App</a> that allows anybody to explore his RYOE metric by season or team and even through three-way rusher comparisons.</p>
<p>Despite a slightly intimidating title, rushing yards over expected is a fantastic entrypoint into exploring model creation and analysis in NFL analytics - in fact, the growing number of “over expected” metrics in the NFL are all great ways to begin learning about and understanding advanced modeling. Robby Greerre, the owner of <a href="https://www.nfeloapp.com/">nfeloapp.com</a> - a website that provides “data-driven analytics, picks, and predictions for the NFL” - explains that over expected metrics are a increasingly popular avenue in which analysts can “paint a more accurate picture of performance by adjusting familiar statistics like ‘completion percentage’ or ‘yards per rush’ for conflating factors like degree of difficulty or game text” <span class="citation" data-cites="nfelo">(<a href="references.html#ref-nfelo" role="doc-biblioref">Greerre 2022</a>)</span>.</p>
<p>Some of these metrics, like completion percentage over expected (CPOE), are widely accepted. Specifically, CPOE calculates how likely any quarterback’s pass is going to be complete or incomplete compared to other passing attempts. It is considered “widely accepted” because the metric itself is considered “stable” in that the r-squared value retains a strong correlation for individual quarterbacks across several seasons. In fact, as Greerre points out, the r-squared value for CPOE for just one season is 0.226 which is extremely strong based on NFL analytics standards.</p>
<p>On the other hand, RYOE - based on Greerre’s analysis - maintains an r-squared value below 0.15 until a running back’s fourth season, wherein the average improves to 0.263 (an otherwise stable value). But that does not mean that RYOE is not a metric worth further exploration. The effectiveness of any one metric to account for factors such as degree of difficulty or game text largely relies on our ability to provide adequate feature engineering - specifically, how much relevant data the machine learning model can ingest to begin making predictions.</p>
<p>Because of that, significant machine learning models have been built with information provided by the NFL’s Big Data Bowl as it is the one chance that the public receives to feature engineer with the NFL’s tracking data (wherein a player’s position, speed, direction, etc. is tracked and recorded every 1/10th of a second). Unfortunately, only small windows of data exist from the Big Data Bowl releases and, as a result, we are often required to find creative ways to provide further context to each play/player for the machine learning model.</p>
<p>To showcase this idea, we are going to begin exploring ways to add additional feature engineering to Tej Seth’s already fantastic Rushing Yard Over Expected model. While not the most stable metric, as mentioned, the idea of RYOE is generally easy to understand for even the most analyst. Broadly, given what we know about every other rushing play during a specific span of seasons, what is the most likely amount of yards a running back is going to gain on a specific rushing play as predicted by the model on other similar situations?</p>
<p><strong>That difference is rushing yards over expected</strong>.</p>
<p>Using Tej’s Shiny app, we can explore all seasons between 2015 and 2022 for those running backs that had a minimum of 755 rushing attempts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/ryoe_2015_2022.jpg" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption class="figure-caption">Credit: Tej Seth</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>According to Tej’s model, since 2015, Nick Chubb of the Cleveland Browns earned - on average - 0.66 over expected. Aaron Jones is closely behind with 0.61 over expected and then a significant drop occurs for the third and fourth players.</p>
<p>To understand how Tej engineered his model and to begin exploring other possible features to feed into the model, we can dive into his <a href="https://github.com/tejseth/RYOE/blob/main/ryoe-2.R">publicly available code</a>.</p>
<section id="tej-seths-ryoe-model-under-the-hood" class="level3" data-number="6.1.1"><h3 data-number="6.1.1" class="anchored" data-anchor-id="tej-seths-ryoe-model-under-the-hood">
<span class="header-section-number">6.1.1</span> Tej Seth’s RYOE Model: Under The Hood</h3>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is important to immediately point out that Tej built his RYOE model using the <code>xgboost</code> package whereas we will begin constructing ours using <code>tidymodels</code>.</p>
<p>While the underlying eXtreme Gradient Boosting process is largely the same with both approaches, the necessary framework we will construct with <code>tidymodels</code> differs <em>greatly</em> from the coding used with the <code>xgboost</code> package.</p>
<p>The <code>xgboost</code> package is a standalone package in R that provide an implementation of the eXtreme Gradient Boosting algorithm. To that end, it offers a highly efficient and flexible way to train gradient boosting models for various machine learning tasks, such as classification, regression, and ranking. The package provides its own set of functions for training, cross-validation, prediction, and feature importance evaluation.</p>
<p>The <code>tidymodels</code> package, on the other hand, is a <em>collection</em> of R packages that provide a unified framework for modeling and machine learning tasks. It includes several package for data preprocessing, modeling, validation, and evaluation. Because of this, the core goal of the <code>tidymodels</code> teams is to offer a consistent syntax and workflow for a wide range of machine learning models. It is a fair comparison to say that <code>tidymodels</code> is the <code>tidyverse</code> of the machine learning world.</p>
</div>
</div>
<p>Just like the model we will be building in this chapter, Tej constructed his model via eXtreme Gradient Boosting.</p>
<p>Which may lead to a very obvious question if you are new to machine learning: <strong>what exactly <em>is</em> eXtreme Gradient Boosting?</strong></p>
</section><section id="extreme-gradient-boosting-explained" class="level3" data-number="6.1.2"><h3 data-number="6.1.2" class="anchored" data-anchor-id="extreme-gradient-boosting-explained">
<span class="header-section-number">6.1.2</span> eXtreme Gradient Boosting Explained</h3>
<p>eXtreme Gradient Boosting (XGBoost) is a powerful machine learning technique that is particularly good at solving supervised machine learning problems, such as classification (categorizing data into classes, for example) and regression (predicting numerical values).</p>
<p>XGBoost can be thought of as an “expert team” that combines the knowledge and skills of multiple “individual experts” to make better decisions or predictions. Each of these “experts” in this context is what we call a decision tree, which is a flowchart structure used for making decisions based on a series of question about the data.</p>
<p>Once provided data, XGBoost seeks to iteratively build a collection of “bad” decision trees and then build an ensemble of these poor ones into a more accurate and robust model. The term “gradient” comes from the fact that the algorithm uses the gradient (or the slope) of the loss function (a measure of how well the model fits the data) to guide the learning process.</p>
</section><section id="building-ryoe-with-xgboost" class="level3" data-number="6.1.3"><h3 data-number="6.1.3" class="anchored" data-anchor-id="building-ryoe-with-xgboost">
<span class="header-section-number">6.1.3</span> Building RYOE with <code>xgboost</code>
</h3>
<p>With a basic understanding of the differences between the <code>xgboost</code> and <code>tidymodels</code> packages, and how the eXtreme Gradient Boosting algorithm works, we can examine how Tej constructed his <code>xgboost</code> model from <code>nflreadR</code> data.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>While I also include my own step-by-step instructional videos for this book, Tej created a video as he created the initial RYOE model in <code>xgboost</code> as part of the M-Fans YouTube channel (<a href="https://www.youtube.com/watch?v=p5LxuIjh6Z8&amp;t=577s">Making a Random Forest and XGBoost Model with NFL Data</a>) and I am happy to share it as it never hurts to go through the critical thinking process with more than one person.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pbp</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pbp.html">load_pbp</a></span><span class="op">(</span><span class="fl">2015</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rush_attempts</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">rush_attempt</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">qb_scramble</span> <span class="op">==</span> <span class="fl">0</span>, </span>
<span>         <span class="va">qb_dropback</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">yards_gained</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">def_ypc</span> <span class="op">&lt;-</span> <span class="va">rush_attempts</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">defteam</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">defteam</span>, <span class="va">season</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>def_ypc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">yards_gained</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rush_attempts</span> <span class="op">&lt;-</span> <span class="va">rush_attempts</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">def_ypc</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"season"</span>, <span class="st">"defteam"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rushing_data_join</span> <span class="op">&lt;-</span> <span class="va">rush_attempts</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span>label <span class="op">=</span> <span class="va">yards_gained</span>, <span class="va">yardline_100</span>, <span class="va">quarter_seconds_remaining</span>,</span>
<span>         <span class="va">half_seconds_remaining</span>, <span class="va">qtr</span>, <span class="va">down</span>, <span class="va">ydstogo</span>, <span class="va">shotgun</span>, <span class="va">no_huddle</span>,</span>
<span>         <span class="va">ep</span>, <span class="va">wp</span>, <span class="va">def_ypc</span>, <span class="va">rusher_player_name</span>, <span class="va">posteam</span>, <span class="va">defteam</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">label</span><span class="op">)</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">down</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rushes</span> <span class="op">&lt;-</span> <span class="va">rushing_data_join</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">rusher_player_name</span>, <span class="op">-</span><span class="va">posteam</span>, <span class="op">-</span><span class="va">defteam</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>While the coding on Tej’s GitHub for his RYOE model differs from the video, I believe the version he constructs in the video is better for instructional purposes as it is a bit less complex (that is: intuitively easier for a novice to machine learning to follow and understand). To start, he uses <code>nflreadr</code> to collect all play-by-play information between the 2015 and 2022 seasons. After, since this is a metric based solely on rushing attempts, he utilizes the <code>filter</code> verb to gather play that are classified as rush attempts, but are <em>not</em> quarterback scrambles or dropbacks and to exclude any row that does not contained a numeric value for <code>yards_gained</code>.</p>
<p>Next, Tej immediately goes into a bit of feature engineering by calculating the averaged yards allowed per rush by each defensive unit. This is not a standardized statistics within <code>nflreadr</code> data so he created a new feature for the machine learning model to make predictions with.</p>
<p>After merging in the defensive stats, Tej created a new dataframe called <code>rushing_data_join</code> off of his existing <code>rush_attempts</code> data and, in doing so, renamed the <code>yards_gained</code> variable <code>label</code> and then did an additional <code>filter</code> for any missing <code>label</code> or <code>down</code>. Lastly, a dataframe called <code>rushes</code> is created from <code>rushing_data_join</code> with the <code>rusher_player_name</code>, <code>posteam</code>, and <code>defteam</code> all being dropped from the data.</p>
<p>The newly created <code>rushes</code> dataframe will be the information carried over into the machine learning process. The dropping of the three variables is to avoid, for example, overfitting as the machine learning model could likely begin learning which stats belong to which specific running back. However, those three variables are still maintained in the <code>rushing_data_join</code> dataframe and, despite being created early in the process, it won’t be used again until after the machine learning process is completed. At that point, it will be used to merge the training and testing predictions <em>back</em> into the play-by-play data to include, importantly, the <code>rusher_player_name</code>.</p>
<p>As this point, the <code>xgboost</code> approach and the <code>tidymodels</code> approach diverge wildly. In the <code>xgboost</code> method, Tej must first turn the <code>down</code>, <code>shotgun</code>, and <code>no_huddle</code> variables into what is called <code>as.factor</code>, thus converting the numeric values associated with each into a factor.</p>
<p>Why just these three variables? <code>down</code>, <code>shotgun</code>, and <code>no_huddle</code> are structured as non-continuous numeric. In other words, the two possible responses for <code>shotgun</code> are <code>0</code> for “no” or <code>1</code> for “yes”. The rushing attempt either occurred from the shotgun formation, or it did not. There is no <code>1.1</code> or anything else between <code>1</code> and <code>2</code>. The same argument can be made for <code>down</code> and <code>no_huddle</code>. Because of this, switching all three to <code><a href="https://rdrr.io/r/base/factor.html">as.factor()</a></code> instructs the model to not predict that there is a continuous line of numbers between 0 and 1.</p>
<p>Next, Tej creates dummy variables within the data. Instead of a single column for <code>shotgun</code> wherein the binary is <code>0</code> or <code>1</code>, there will now be two columns for the <code>shotgun</code> variable: <code>shotgun.0</code> and <code>shotgun.1</code> with the appropriate value in each. If <code>shotgun.0</code> is set to a binary of <code>0</code> for a play, then <code>shotgun.1</code> must be a value of <code>1</code> since a play cannot take place <em>both</em> in the shotgun and from under center.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rushes</span><span class="op">$</span><span class="va">down</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">rushes</span><span class="op">$</span><span class="va">down</span><span class="op">)</span></span>
<span><span class="va">rushes</span><span class="op">$</span><span class="va">shotgun</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">rushes</span><span class="op">$</span><span class="va">shotgun</span><span class="op">)</span></span>
<span><span class="va">rushes</span><span class="op">$</span><span class="va">no_huddle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">rushes</span><span class="op">$</span><span class="va">no_huddle</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dmy</span> <span class="op">&lt;-</span> <span class="fu">dummyVars</span><span class="op">(</span><span class="st">" ~ ."</span>, data <span class="op">=</span> <span class="va">rushes</span><span class="op">)</span></span>
<span><span class="va">rushing_model_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">dmy</span>, newdata <span class="op">=</span> <span class="va">rushes</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, the data is split into training and testing and the modeling system is created within the <code>params</code> function. All that information is then passed into the <code><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost::xgboost</a></code> function that ultimately runs and creates the model.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">smp_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="fl">0.80</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">rushes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">rushes</span><span class="op">)</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">smp_size</span><span class="op">)</span></span>
<span><span class="va">ind_train</span> <span class="op">&lt;-</span> <span class="va">rushes</span><span class="op">[</span><span class="va">ind</span>, <span class="op">]</span></span>
<span><span class="va">ind_test</span> <span class="op">&lt;-</span> <span class="va">rushes</span><span class="op">[</span><span class="op">-</span><span class="va">ind</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">full_train</span> <span class="op">&lt;-</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">ind_train</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">label</span><span class="op">)</span><span class="op">)</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">ind_train</span><span class="op">$</span><span class="va">label</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nrounds</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    booster <span class="op">=</span> <span class="st">"gbtree"</span>,</span>
<span>    objective <span class="op">=</span> <span class="st">"multi:softprob"</span>,</span>
<span>    eval_metric <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mlogloss"</span><span class="op">)</span>,</span>
<span>    num_class <span class="op">=</span> <span class="fl">26</span>,</span>
<span>    eta <span class="op">=</span> <span class="fl">.012</span>,</span>
<span>    gamma <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    subsample<span class="op">=</span><span class="fl">0.8</span>,</span>
<span>    colsample_bytree<span class="op">=</span><span class="fl">0.8</span>,</span>
<span>    max_depth <span class="op">=</span> <span class="fl">8</span>,</span>
<span>    min_child_weight <span class="op">=</span> <span class="fl">21</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">ryoe_model</span> <span class="op">&lt;-</span> <span class="fu">xgboost</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html">xgboost</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">params</span>, data <span class="op">=</span> <span class="va">full_train</span>, nrounds <span class="op">=</span> <span class="va">nrounds</span>, verbose <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As mentioned, we are going to take the basic skeleton of Tej’s RYOE model and recreate it within the <code>tidymodels</code> framework. Moreover, we will incorporate data from other sources to add to the defensive rushing yards allowed feature engineering implemented by Tej.</p>
</section></section><section id="building-a-ryoe-model-with-xgboost-in-tidymodels" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="building-a-ryoe-model-with-xgboost-in-tidymodels">
<span class="header-section-number">6.2</span> Building a RYOE Model with XGBoost in <code>tidymodels</code>
</h2>
</section><section id="navigating-the-nfls-big-data-bowl" class="level2" data-number="6.3"><h2 data-number="6.3" class="anchored" data-anchor-id="navigating-the-nfls-big-data-bowl">
<span class="header-section-number">6.3</span> Navigating the NFL’s Big Data Bowl</h2>
<p>lots of place holding for Big Data Bowl material below</p>
<p>Thomas Bliss, a Data Scientist with the NFL, <a href="https://www.kaggle.com/competitions/nfl-big-data-bowl-2023/discussion/365497">provided an incredibly helpful list of potential topics</a> that can be explored using 2023 Big Data Bowl information:</p>
<ol type="1">
<li>analyze blocker positioning after the QB leaves the pocket and/or is pressured</li>
<li>analyze blocker ability to hold a defender in place without moving towards the QB</li>
<li>link the rate of false starts to an offensive line’s time off the snap</li>
<li>link between QB release time, receiver separation, and offensive line performance</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### reading all weeks and writing to a parquet file</span></span>
<span><span class="va">all_bdb_weeks</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'core-data'</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">paths</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op">(</span><span class="va">dir</span>, regexp <span class="op">=</span> <span class="st">'week\\d+'</span><span class="op">)</span></span>
<span>  <span class="va">all_weeks</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">paths</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_df</a></span><span class="op">(</span><span class="fu">vroom</span><span class="fu">::</span><span class="va"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'core-data'</span>, <span class="st">'data.parquet'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">all_bdb_weeks</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### reading in all play information provided and writing to a parquet file</span></span>
<span><span class="va">read_bdb_plays</span> <span class="op">&lt;-</span> <span class="fu">memoise</span><span class="fu">::</span><span class="fu"><a href="https://memoise.r-lib.org/reference/memoise.html">memoise</a></span><span class="op">(</span><span class="op">{</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">plays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'core-data'</span>, <span class="st">'plays.csv'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'core-data'</span>, <span class="st">'plays.parquet'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">read_bdb_plays</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### reading in individual game information and writing to a parquet file</span></span>
<span><span class="va">read_game_info</span> <span class="op">&lt;-</span> <span class="fu">memoise</span><span class="fu">::</span><span class="fu"><a href="https://memoise.r-lib.org/reference/memoise.html">memoise</a></span><span class="op">(</span><span class="op">{</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'core-data'</span>, <span class="st">'games.csv'</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span>game_date <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="va"><a href="https://lubridate.tidyverse.org/reference/ymd.html">mdy</a></span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'core-data'</span>, <span class="st">'games.parquet'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### creating an individual .cvs file for each game in bdb</span></span>
<span><span class="va">all.weeks</span> <span class="op">&lt;-</span> <span class="fu">read_parquet</span><span class="op">(</span><span class="st">"./core-data/large-lfs-files/all-weeks-parquet"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.weeks</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">game_id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_walk</span><span class="op">(</span><span class="op">~</span> <span class="fu">write_csv</span><span class="op">(</span><span class="va">.x</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'tracking_gameId_'</span>, <span class="va">.y</span><span class="op">$</span><span class="va">game_id</span>, <span class="st">".csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### writing in team colors, logos</span></span>
<span><span class="va">team.colors</span> <span class="op">&lt;-</span> <span class="fu">nflfastR</span><span class="fu">::</span><span class="va"><a href="https://www.nflfastr.com/reference/teams_colors_logos.html">teams_colors_logos</a></span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">team_abbr</span>, <span class="va">team_color</span>, <span class="va">team_color2</span>, <span class="va">team_logo_espn</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>fffff</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rotate_the_dots</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"play_direction"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Cannot find play directions. Inferring from offense and defense locations at snap."</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">event</span> <span class="op">==</span> <span class="st">"ball_snap"</span>, <span class="va">team</span> <span class="op">!=</span> <span class="st">"football"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">group_by</span><span class="op">(</span><span class="va">game_id</span>, <span class="va">play_id</span>, <span class="va">defensive_team</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">summarize</span><span class="op">(</span>mean_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">defensive_team</span>, values_from <span class="op">=</span> <span class="va">mean_x</span>, names_prefix <span class="op">=</span> <span class="st">"x_"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">mutate</span><span class="op">(</span></span>
<span>        play_direction <span class="op">=</span> </span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>            <span class="va">x_1</span> <span class="op">&gt;</span> <span class="va">x_0</span>,</span>
<span>            <span class="st">"right"</span>,</span>
<span>            <span class="st">"left"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>          <span class="fu">select</span><span class="op">(</span><span class="va">game_id</span>, <span class="va">play_id</span>, <span class="va">play_direction</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>          <span class="fu">inner_join</span><span class="op">(</span><span class="va">df</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"game_id"</span>, <span class="st">"play_id"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>        </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span></span>
<span>      to_left <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">play_direction</span> <span class="op">==</span> <span class="st">"left"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">to_left</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">120</span> <span class="op">-</span> <span class="va">x</span>, <span class="va">x</span><span class="op">)</span>,</span>
<span>      y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">to_left</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">160</span> <span class="op">/</span> <span class="fl">3</span> <span class="op">-</span> <span class="va">y</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>      los_x <span class="op">=</span> <span class="fl">100</span> <span class="op">-</span> <span class="va">absolute_yardline_number</span>,</span>
<span>      dist_from_los <span class="op">=</span> <span class="va">x</span> <span class="op">-</span> <span class="va">los_x</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="st">"o"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">mutate</span><span class="op">(</span></span>
<span>        o <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">to_left</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">o</span> <span class="op">+</span> <span class="fl">180</span>, <span class="va">o</span><span class="op">)</span>,</span>
<span>        o <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">o</span> <span class="op">&gt;</span> <span class="fl">360</span>, <span class="fl">0</span> <span class="op">-</span> <span class="fl">360</span>, <span class="va">o</span><span class="op">)</span>,</span>
<span>        o_rad <span class="op">=</span> <span class="va">pi</span> <span class="op">*</span> <span class="op">(</span><span class="va">o</span> <span class="op">/</span> <span class="fl">180</span><span class="op">)</span>,</span>
<span>        o_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">o</span><span class="op">)</span>, <span class="cn">NA_real_</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">o_rad</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        o_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">o</span><span class="op">)</span>, <span class="cn">NA_real_</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">o_rad</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="st">"dir"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">mutate</span><span class="op">(</span></span>
<span>        dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">to_left</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">dir</span> <span class="op">+</span> <span class="fl">180</span>, <span class="va">dir</span><span class="op">)</span>,</span>
<span>        dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dir</span> <span class="op">&gt;</span> <span class="fl">360</span>, <span class="va">dir</span> <span class="op">-</span> <span class="fl">360</span>, <span class="va">dir</span><span class="op">)</span>,</span>
<span>        dir_rad <span class="op">=</span> <span class="va">pi</span> <span class="op">*</span> <span class="op">(</span><span class="va">dir</span> <span class="op">/</span> <span class="fl">180</span><span class="op">)</span>,</span>
<span>        dir_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span>, <span class="cn">NA_real_</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">dir_rad</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        dir_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span>, <span class="cn">NA_real_</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">dir_rad</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        s_x <span class="op">=</span> <span class="va">dir_x</span> <span class="op">*</span> <span class="va">s</span>,</span>
<span>        s_y <span class="op">=</span> <span class="va">dir_y</span> <span class="op">*</span> <span class="va">s</span>,</span>
<span>        a_x <span class="op">=</span> <span class="va">dir_x</span> <span class="op">*</span> <span class="va">a</span>,</span>
<span>        a_y <span class="op">=</span> <span class="va">dir_y</span> <span class="op">*</span> <span class="va">a</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ffff</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">find_o_diff</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">prefix</span> <span class="op">=</span> <span class="st">"qb"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">name_x</span> <span class="op">&lt;-</span> <span class="fu">sym</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">prefix</span>, <span class="st">"_x"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">name_y</span> <span class="op">&lt;-</span> <span class="fu">sym</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">prefix</span>, <span class="st">"_y"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">new_column</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"o_to_"</span>, <span class="va">prefix</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span></span>
<span>      dis_x <span class="op">=</span> <span class="op">{</span><span class="op">{</span><span class="va">name_x</span><span class="op">}</span><span class="op">}</span> <span class="op">-</span> <span class="va">x</span>,</span>
<span>      dis_y <span class="op">=</span> <span class="op">{</span><span class="op">{</span><span class="va">name_y</span><span class="op">}</span><span class="op">}</span> <span class="op">-</span> <span class="va">y</span>,</span>
<span>      </span>
<span>      tmp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">atan2</a></span><span class="op">(</span><span class="va">dis_y</span>, <span class="va">dis_x</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">180</span> <span class="op">/</span> <span class="va">pi</span><span class="op">)</span>,</span>
<span>      tmp <span class="op">=</span> <span class="op">(</span><span class="fl">360</span> <span class="op">-</span> <span class="va">tmp</span><span class="op">)</span> <span class="op">+</span> <span class="fl">90</span>,</span>
<span>      tmp <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">tmp</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">tmp</span> <span class="op">+</span> <span class="fl">360</span>,</span>
<span>                      <span class="va">tmp</span> <span class="op">&gt;</span> <span class="fl">360</span> <span class="op">~</span> <span class="va">tmp</span> <span class="op">-</span> <span class="fl">360</span>,</span>
<span>                      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">tmp</span><span class="op">)</span>,</span>
<span>      </span>
<span>      diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">o</span> <span class="op">-</span> <span class="va">tmp</span><span class="op">)</span>,</span>
<span>      </span>
<span>      diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">o</span> <span class="op">-</span> <span class="va">tmp</span><span class="op">)</span>,</span>
<span>      </span>
<span>      <span class="op">!</span><span class="op">!</span><span class="va">new_column</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="fl">360</span> <span class="op">-</span> <span class="va">diff</span>, <span class="va">diff</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">diff</span>, <span class="op">-</span><span class="va">tmp</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">########</span></span>
<span><span class="co">## READING IN PITTSBURGH VS. BUFFALO - WEEK 1</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">pitt.buff</span> <span class="op">&lt;-</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html">read_parquet</a></span><span class="op">(</span><span class="st">"core-data/large-lfs-files/all-weeks-parquet"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">game_id</span> <span class="op">==</span> <span class="st">"2021091201"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## READING IN PLAYS FROM PITTSBURGH VS. BUFFALO - WEEK 1</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">pitt.buff.plays</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"core-data/plays.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">game_id</span> <span class="op">==</span> <span class="st">"2021091201"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## READING IN GAME INFO FROM PITTSBURGH VS. BUFFALO - WEEK 1</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">pitt.buff.info</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"core-data/games.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">game_id</span> <span class="op">==</span> <span class="st">"2021091201"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## COMBING CORE GAME FILE WITH PLAYS, AND THEN BY INFO (TO AVOID MULTIPLE GAME_IDs IN DF)</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">complete.data</span> <span class="op">&lt;-</span> <span class="fu">inner_join</span><span class="op">(</span><span class="va">pitt.buff</span>, <span class="va">pitt.buff.plays</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"game_id"</span> <span class="op">=</span> <span class="st">"game_id"</span>, <span class="st">"play_id"</span> <span class="op">=</span> <span class="st">"play_id"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">complete.data</span> <span class="op">&lt;-</span> <span class="va">complete.data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">pitt.buff.info</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"game_id"</span> <span class="op">=</span> <span class="st">"game_id"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ROTATING THE DOTS</span></span>
<span><span class="va">complete.data</span> <span class="op">&lt;-</span> <span class="fu">rotate_the_dots</span><span class="op">(</span><span class="va">complete.data</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## MUTATING TO CHARACTER VARIABLE DEFINING WHETHER TEAM IN FRAMES IS ON OFFENSE OR DEFENSE</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">complete.data</span> <span class="op">&lt;-</span> <span class="va">complete.data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>off_or_def <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">team</span> <span class="op">==</span> <span class="va">possession_team</span> <span class="op">~</span> <span class="st">"offense"</span>,</span>
<span>    <span class="va">team</span> <span class="op">!=</span> <span class="va">possession_team</span> <span class="op">~</span> <span class="st">"defense"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"football"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>            <span class="co">########</span></span>
<span>            <span class="co">## CORE CLEANING AND PREP IS COMPLETE</span></span>
<span>            <span class="co">########</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## ADDING IN INFORMATION FROM PLAYERS.CSV TO BUILD CHULLs FOR JUST O-LINE</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">player.info</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"core-data/players.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">nfl_id</span>, <span class="va">official_position</span>, <span class="va">display_name</span><span class="op">)</span></span>
<span></span>
<span><span class="va">complete.data</span> <span class="op">&lt;-</span> <span class="va">complete.data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">inner_join</span><span class="op">(</span><span class="va">player.info</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nfl_id"</span> <span class="op">=</span> <span class="st">"nfl_id"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## LET'S PICK OUT A FUN PLAY TO WORK WITH</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">one.play</span> <span class="op">&lt;-</span> <span class="va">complete.data</span> <span class="op">%&gt;%</span>  <span class="co">### BEN PASS TO EBRON FOR 19 YARDS</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">play_id</span> <span class="op">==</span> <span class="fl">2209</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## NOW LET'S BUILD A CONVEX HULL FOR JUST THE OFFENSIVE LINE</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">ol_chull_order</span> <span class="op">&lt;-</span> <span class="va">one.play</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">off_or_def</span> <span class="op">==</span> <span class="st">"offense"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">official_position</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T"</span>, <span class="st">"C"</span>, <span class="st">"G"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co">#### IMPORTANT TO KNOW PERSONNEL PACKAGE HERE: 0 RB, 0 TE, 5 WR</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">frame_id</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="va">chull</span></span>
<span></span>
<span><span class="va">ol_chull_order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ol_chull_order</span>, <span class="va">ol_chull_order</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ol_chull_coords</span> <span class="op">&lt;-</span> <span class="va">one.play</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">off_or_def</span> <span class="op">==</span> <span class="st">"offense"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">frame_id</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">slice</span><span class="op">(</span><span class="va">ol_chull_order</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ol_chull_poly</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/SpatialPolygons.html">Polygon</a></span><span class="op">(</span><span class="va">ol_chull_coords</span>, hole <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">ol_chull_area</span> <span class="op">&lt;-</span> <span class="va">ol_chull_poly</span><span class="op">@</span><span class="va">area</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## NOW LET'S PLOT IT</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">one.play</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">the_dots</span><span class="op">(</span></span>
<span>    animated <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    orientation <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    convex <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    segment_length <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    segment_size <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    dot_size <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    animated_h <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    animated_w <span class="op">=</span> <span class="fl">8</span>,</span>
<span>    animated_res <span class="op">=</span> <span class="fl">150</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-nfelo" class="csl-entry" role="doc-biblioentry">
Greerre, Robby. 2022. <span>“Over Expected Metrics Explained – What Are CPOE, RYOE, and YACOE.”</span> <a href="https://www.nfeloapp.com/analysis/over-expected-explained-what-are-cpoe-ryoe-and-yacoe/">https://www.nfeloapp.com/analysis/over-expected-explained-what-are-cpoe-ryoe-and-yacoe/</a>.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>Thanks to Tej Seth for briefly chatting with me over Twitter regarding the history of both Michael’s RYOE model and his own.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./04-nfl-analytics-visualization.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Data Visualization with NFL Analytics</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">NFL Analytics with R was written by Bradley J. Congelio.</div>   
    <div class="nav-footer-right">This book was built with <a href="https://quarto.org/">Quarto</a></div>
  </div>
</footer>


</body></html>