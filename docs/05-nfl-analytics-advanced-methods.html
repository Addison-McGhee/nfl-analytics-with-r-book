<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>An Introduction to NFL Analytics with R - 6&nbsp; Advanced Methods: Modeling and Big Data Bowl</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./04-nfl-analytics-visualization.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-0ZLEFZL898"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-0ZLEFZL898', { 'anonymize_ip': true});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">
<span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Advanced Methods: Modeling and Big Data Bowl</span>
</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">An Introduction to NFL Analytics with R</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/bcongelio/nfl-analytics-with-r-book" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
    <a href="" title="Share" id="sidebar-tool-dropdown-0" class="sidebar-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-share"></i></a>
    <ul class="dropdown-menu" aria-labelledby="sidebar-tool-dropdown-0">
<li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
            <i class="bi bi-bi-twitter pe-1"></i>
          Twitter
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
            <i class="bi bi-bi-facebook pe-1"></i>
          Facebook
          </a>
        </li>
        <li>
          <a class="dropdown-item sidebar-tools-main-item" href="https://www.linkedin.com/sharing/share-offsite/?url=%7Curl%7C">
            <i class="bi bi-bi-linkedin pe-1"></i>
          LinkedIn
          </a>
        </li>
    </ul>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-nfl-analytics-and-r.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">An Introduction to NFL Analytics and the R Programming Language</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-nfl-analytics-tidyverse.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Wrangling NFL Data in the <code>tidyverse</code></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-nfl-analytics-functions.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">NFL Analytics with the <code>nflverse</code> Family of Packages</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-nfl-analytics-visualization.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Data Visualization with NFL Analytics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-nfl-analytics-advanced-methods.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Advanced Methods: Modeling and Big Data Bowl</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Appendices</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a1-nfl-analytics-dictionary.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">NFL Analytics Reference Guide</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./a2-nfl-further-reading.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Further Reading Suggestions</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction-to-statistics-and-modeling-with-nfl-data" id="toc-introduction-to-statistics-and-modeling-with-nfl-data" class="nav-link active" data-scroll-target="#introduction-to-statistics-and-modeling-with-nfl-data"><span class="toc-section-number">6.1</span>  Introduction to Statistics and Modeling with NFL Data</a></li>
  <li><a href="#basic-statistical-modeling" id="toc-basic-statistical-modeling" class="nav-link" data-scroll-target="#basic-statistical-modeling"><span class="toc-section-number">6.2</span>  Basic Statistical Modeling</a></li>
  <li>
<a href="#deciphering-statistical-results" id="toc-deciphering-statistical-results" class="nav-link" data-scroll-target="#deciphering-statistical-results"><span class="toc-section-number">6.3</span>  Deciphering Statistical Results</a>
  <ul class="collapse">
<li><a href="#understanding-linear-regression-results" id="toc-understanding-linear-regression-results" class="nav-link" data-scroll-target="#understanding-linear-regression-results"><span class="toc-section-number">6.3.1</span>  Understanding Linear Regression Results</a></li>
  <li><a href="#logistic-regressions" id="toc-logistic-regressions" class="nav-link" data-scroll-target="#logistic-regressions"><span class="toc-section-number">6.3.2</span>  Logistic Regressions</a></li>
  </ul>
</li>
  <li>
<a href="#advanced-regression-techniques" id="toc-advanced-regression-techniques" class="nav-link" data-scroll-target="#advanced-regression-techniques"><span class="toc-section-number">6.4</span>  Advanced Regression Techniques</a>
  <ul class="collapse">
<li><a href="#regularization" id="toc-regularization" class="nav-link" data-scroll-target="#regularization"><span class="toc-section-number">6.4.1</span>  Regularization</a></li>
  <li><a href="#generalized-linear-and-additive-models-glmgam" id="toc-generalized-linear-and-additive-models-glmgam" class="nav-link" data-scroll-target="#generalized-linear-and-additive-models-glmgam"><span class="toc-section-number">6.4.2</span>  Generalized Linear and Additive Models (GLM/GAM)</a></li>
  </ul>
</li>
  <li>
<a href="#advanced-modeling-techniques" id="toc-advanced-modeling-techniques" class="nav-link" data-scroll-target="#advanced-modeling-techniques"><span class="toc-section-number">6.5</span>  Advanced Modeling Techniques</a>
  <ul class="collapse">
<li><a href="#clustering" id="toc-clustering" class="nav-link" data-scroll-target="#clustering"><span class="toc-section-number">6.5.1</span>  Clustering</a></li>
  <li><a href="#decision-treesrandom-forests" id="toc-decision-treesrandom-forests" class="nav-link" data-scroll-target="#decision-treesrandom-forests"><span class="toc-section-number">6.5.2</span>  Decision Trees/Random Forests</a></li>
  </ul>
</li>
  <li>
<a href="#creating-our-own-rushing-yards-over-expected-model" id="toc-creating-our-own-rushing-yards-over-expected-model" class="nav-link" data-scroll-target="#creating-our-own-rushing-yards-over-expected-model"><span class="toc-section-number">6.6</span>  Creating Our Own Rushing Yards Over Expected Model</a>
  <ul class="collapse">
<li><a href="#tej-seths-ryoe-model-under-the-hood" id="toc-tej-seths-ryoe-model-under-the-hood" class="nav-link" data-scroll-target="#tej-seths-ryoe-model-under-the-hood"><span class="toc-section-number">6.6.1</span>  Tej Seth’s RYOE Model: Under The Hood</a></li>
  <li><a href="#extreme-gradient-boosting-explained" id="toc-extreme-gradient-boosting-explained" class="nav-link" data-scroll-target="#extreme-gradient-boosting-explained"><span class="toc-section-number">6.6.2</span>  eXtreme Gradient Boosting Explained</a></li>
  </ul>
</li>
  <li><a href="#building-a-ryoe-model-with-tidymodels" id="toc-building-a-ryoe-model-with-tidymodels" class="nav-link" data-scroll-target="#building-a-ryoe-model-with-tidymodels"><span class="toc-section-number">6.7</span>  Building a RYOE Model with <code>tidymodels</code></a></li>
  <li><a href="#navigating-the-nfls-big-data-bowl" id="toc-navigating-the-nfls-big-data-bowl" class="nav-link" data-scroll-target="#navigating-the-nfls-big-data-bowl"><span class="toc-section-number">6.8</span>  Navigating the NFL’s Big Data Bowl</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title d-none d-lg-block">
<span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Advanced Methods: Modeling and Big Data Bowl</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><section id="introduction-to-statistics-and-modeling-with-nfl-data" class="level2" data-number="6.1"><h2 data-number="6.1" class="anchored" data-anchor-id="introduction-to-statistics-and-modeling-with-nfl-data">
<span class="header-section-number">6.1</span> Introduction to Statistics and Modeling with NFL Data</h2>
</section><section id="basic-statistical-modeling" class="level2" data-number="6.2"><h2 data-number="6.2" class="anchored" data-anchor-id="basic-statistical-modeling">
<span class="header-section-number">6.2</span> Basic Statistical Modeling</h2>
</section><section id="deciphering-statistical-results" class="level2" data-number="6.3"><h2 data-number="6.3" class="anchored" data-anchor-id="deciphering-statistical-results">
<span class="header-section-number">6.3</span> Deciphering Statistical Results</h2>
<p>information here will be provided to assist in understanding what the results of the models mean and will serve as a reference point for the rest of the chapter.</p>
<section id="understanding-linear-regression-results" class="level3" data-number="6.3.1"><h3 data-number="6.3.1" class="anchored" data-anchor-id="understanding-linear-regression-results">
<span class="header-section-number">6.3.1</span> Understanding Linear Regression Results</h3>
<p>Using the below example that explores the relationship between an NFL’s teams total yards and total points over the course of a season, the results of a linear regression model calculated using the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> function includes the following information (explained afterward):</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">`Residuals:</span></span>
<span><span class="va">    Min      1Q  Median      3Q     Max </span></span>
<span><span class="va">-71.443 -22.334   1.157  19.145  68.080 </span></span>
<span><span class="va"></span></span>
<span><span class="va">Coefficients:</span></span>
<span><span class="va">              Estimate Std. Error t value      Pr(&gt;|t|)    </span></span>
<span><span class="va">(Intercept) -225.03520   65.44927  -3.438       0.00174 ** </span></span>
<span><span class="va">total_yards    0.10341    0.01132   9.135 0.00000000036 ***</span></span>
<span><span class="va">---</span></span>
<span><span class="va">Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</span></span>
<span><span class="va"></span></span>
<span><span class="va">Residual standard error: 32.04 on 30 degrees of freedom</span></span>
<span><span class="va">Multiple R-squared:  0.7356,    Adjusted R-squared:  0.7268 </span></span>
<span><span class="va">F-statistic: 83.45 on 1 and 30 DF,  p-value: 0.0000000003599`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="residuals" class="level4" data-number="6.3.1.1"><h4 data-number="6.3.1.1" class="anchored" data-anchor-id="residuals">
<span class="header-section-number">6.3.1.1</span> Residuals</h4>
<p>A linear model’s residuals are the calculated difference between actual values of the dependent values as found in the data used to build the model and those values predicted by the regression model. In a perfect uniform relationship, all of the values from a dataset would sit perfectly on top of the “line of best fit.” Take the below graph, for example.</p>
<div class="cell" data-layout-align="center" data-fig.dpi="400">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="05-nfl-analytics-advanced-methods_files/figure-html/perfect-line-of-fit-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>In this example model, our regression model was able to successfully capture the entirety of the relationship between <code>Our Predictor Variable</code> on the x-axis and the <code>Our Response Variable</code> on the y-axis. This means that the model leaves no unexplained or undetermined variance between the variables and, because of this, the model can take additional unused data to predict, with 100% accuracy, the resulting value of the dependent variable. <strong>It is exceedingly rare to have real-world data be perfectly situated on the line of best fit</strong>. In fact, it is more often than not a sign of “overfitting,” which occurs when the model successfully discovers the “random noise” in the data. In the majority of cases, a regression model with a perfect line of fit will perform exceedingly poorly when introduced to unseen data.</p>
<p>A regression model that is not “overfitted” will have data points that do not fit on the line of best fit, but fall over and under it. The results of the regression model uses a simple formula - <code>residual = observed_value - predicted_value</code> to help us interpret the difference between those actual and estimated values.</p>
<p>The information produced in the example <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> summary above includes statistical information about the distribution of the model’s residual errors.</p>
<table class="table">
<colgroup>
<col style="width: 18%">
<col style="width: 81%">
</colgroup>
<thead><tr class="header">
<th style="text-align: center;">Summary Distribution</th>
<th style="text-align: center;">Meaning</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">The <code>Min</code> Distribution</td>
<td style="text-align: center;">The <code>Min</code> distribution provides the smallest difference between the actual values of the model’s predictor variable (total points) and the predicted. In the example summary, <strong>the minimum residual is -71.443 which means that the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> model predicted that one specific team scored 71.443 more points than it actually did.</strong>
</td>
</tr>
<tr class="even">
<td style="text-align: center;">The <code>1Q</code> Distribution</td>
<td style="text-align: center;">The <code>1Q</code> distribution is based on the first quartile of the data (or where the first 25% of the model’s residual fall on the line of best fit). <strong>The <code>1Q</code> residual is -22.334, which means the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> model predicted that 25% of the teams scored 22.334 more points than the actual values.</strong>
</td>
</tr>
<tr class="odd">
<td style="text-align: center;">The <code>Median</code> Distribution</td>
<td style="text-align: center;">The <code>Median</code> distribution, much like the <code>1Q</code> distribution is data from the first quartile, is the residuals from the 50th percentile of the data. <strong>The <code>Median</code> residual in the above summary is 1.157, which means that the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> model - for 50% of teams - either overestimated or underestimated a teams total points by less than 1.157 points.</strong>
</td>
</tr>
<tr class="even">
<td style="text-align: center;">The <code>3Q</code> Distribution</td>
<td style="text-align: center;">Covering the third quartile of the residuals, <strong>the <code>3Q</code> Distribution is 19.145 which means that 75% of the NFL teams in the data had a total points prediction either overestimated or underestimated by less than 19.145 points.</strong>
</td>
</tr>
<tr class="odd">
<td style="text-align: center;">The <code>Max</code> Distribution</td>
<td style="text-align: center;">The opposite of the <code>Min</code> distribution, the <code>Max</code> distribution is the largest difference between the model’s observed and predicted values for a team’s total points. In this case, for one specific team, <strong>the model predicted the team scored 68.080 points less than the actual value.</strong>
</td>
</tr>
</tbody>
</table>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>A model’s residuals allow you to quickly get a broad view of how accurately it is predicting the data. Ideally, a well-performing model will return residuals that are small and distributed around zero in a consistent fashion. Residuals that are both small and evenly dispersed around zero are the first sign that the model is making predictions that are close to the actual value in the data and is avoiding both over- and underestimating.</p>
<p><strong>But this is not always the case</strong>.</p>
<p>For example, we can compare our above example’s residuals to the below residual output produced by manually creating a dataset.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
-13.7015  -2.1831  -0.5963   0.0000   4.1594  10.5359 </code></pre>
</div>
</div>
<p>Compared to the residuals from the above NFL data, the residuals from the randomly created data are small in comparison and are more evenly distributed around zero. Given that, it is likely that the linear model is doing a good job at making predictions that are close to the actual value.</p>
<p><strong>But that does not mean the residuals from the NFL data indicate a flawed and unreliable model</strong>. It needs to be noted that the “goodness” of any specific linear regression model is wholly dependent on both the context and the specific problem that the model is attempting to predict. To that end, it is also a matter of trusting your subject matter expertise on matters regarding the NFL.</p>
<p>There could be any number of reasons that can explain why the residuals from the regression model are large and not evenly distributed from zero. For example:</p>
<ol type="1">
<li>
<strong>Red-zone efficiency</strong>: a team that moves the ball downfield with ease, but then struggles to score points once inside the 20-yardline , will accumulate <code>total_yards</code> but failed to produce <code>total_points</code> in the way the model predicted.</li>
<li>
<strong>Turnovers:</strong> Similar to above, a team may rack up <code>total_yards</code> but ultimately continue to turn the ball over prior to being able to score.</li>
<li>
<strong>Defensive scoring</strong>: a score by a team’s defense, in this model, still counts towards <code>total_points</code> but does not count towards <code>total_yards</code>.</li>
<li>
<strong>Strength of Opponent</strong>: At the end of the 2022 season, the Philadelphia Eagles and the New York Jets both allowed just 4.8 yards per play. The model’s predicted values of the other three teams in each respective division (NFC East and AFC East) could be incorrect because information, for example, the opponent’s strength of defense was not included in the model.</li>
</ol>
<p>All that to say: residuals are a first glance at the results of the data and provide a <strong>broad</strong> generalization of how the model performed without taking outside contextual factors into consideration.</p>
</div>
</div>
</section><section id="coefficients" class="level4" data-number="6.3.1.2"><h4 data-number="6.3.1.2" class="anchored" data-anchor-id="coefficients">
<span class="header-section-number">6.3.1.2</span> Coefficients</h4>
<p>ffff</p>
</section><section id="simple-linear-regression" class="level4" data-number="6.3.1.3"><h4 data-number="6.3.1.3" class="anchored" data-anchor-id="simple-linear-regression">
<span class="header-section-number">6.3.1.3</span> Simple Linear Regression</h4>
<p>A simple linear regression is a fundamental statistical technique that is used to explore the relationship between two variables, specifically the dependent variable (also called the “response variable”) and the independent variable (also called the “predictor”). By using a simple linear regression, we can model the relationship between the two variables as a linear equation that best fits the observed data points.</p>
<p>A simple linear regression aims to fit a straight line through all the observed data points in such a way that the total squared distance between the actual observations and the values predicted by the model are minimal. This line is often referred to as either the “line of best fit” or the “regression line” and it represents the interaction between the dependent and independent variables. Mathematically, the equation for a simple linear regression is as follows:</p>
<p><span class="math display">\[
Y = {\beta}_0 + {\beta}_1 * X + \epsilon
\]</span></p>
<ol type="1">
<li>
<span class="math inline">\(Y\)</span>, in the above equation, is the dependent variable where the <span class="math inline">\(X\)</span> represents the independent variable.</li>
<li>
<span class="math inline">\({\beta}_o\)</span> is the intercept of the regression model.</li>
<li>
<span class="math inline">\({\beta}_1\)</span> is the slope of the model’s “line of best fit.”</li>
<li>
<span class="math inline">\(\epsilon\)</span> represents the error term.</li>
</ol>
<p>To better illustrate this, let’s use basic football terms using the above regression equation to compare a team’s offensive points scored in a season based on how many offensive yards it accumulated. The intercept (<span class="math inline">\({\beta}_o\)</span>) represents the value when a team’s points scored and offensive yards are both zero. The slope (<span class="math inline">\({\beta}_1\)</span>) represents the rate of change in <span class="math inline">\(Y\)</span> as the unit of <span class="math inline">\(X\)</span> changes. The error term (<span class="math inline">\(\epsilon\)</span>) is represents the difference between the actual observed values of the regression’s dependent variable and the value as predicted by the model.</p>
<p>Using our points scored/total yards example, a team’s total yards gained is the <strong>independent variable</strong> and total points scored is the <strong>dependent variable</strong>, as a team’s total yardage <strong>is what drives the change in total points</strong> (in other words, a team’s total points <em>is dependent</em> on its total yardage). A team will not score points in the NFL if it is not also gaining yardage. We can view this relationship by building a simple linear regression model in R using the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> function.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> function is a built-in function in RStudio that stands for “linear model” and is used, as described above, to fit a linear regression to the data that you provide. The completed regression estimates the coefficients of the regression, and also includes both the intercept and slope, which are the main factors in explaining the relationship between your data’s response and predictor variables.</p>
<p>The <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> function requires just two arguments in order to provide results: a formula and the dataframe to use and is structured like so: <code>model_results &lt;- lm(formula, data)</code>.</p>
<p>The <code>formula</code> argument require that you specify both the response and predictor variables, as named in your dataframe, in the structure of <code>Y ~ X</code>(wherein <code>Y</code> is the response variables and <code>X</code> is the predictor). In the case that you have more than one predictor variable, the <code>+</code> is used to add to the formula (<code>lm(Y ~ X1 + X2</code>).</p>
<p>The <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> function returns the coefficients, residuals, and other statistics of the model in a <code>lm</code> data object. There are There are numerous ways to access this data which are discussed in further detail below.</p>
</div>
</div>
<p>Let’s build a simple linear regression model that explores the relationship between the total yardage earned by a team over the course of a season and the number of points scored. To begin, place the prepared data in the <code>simple_regression_data</code> dataframe by running the code below.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">simple_regression_data</span> <span class="op">&lt;-</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/bcongelio/nfl-analytics-with-r-book/origin/example_data/csv/simple_regression_data.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simple_regression_data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data contains the total yardage and points scored for each NFL team between 2012 and 2022. The data does not include any playoff games. Before running a model on all ten years of data, we will begin by selecting just information from 2022 and then build our <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> model. Beforehand, though, we can take the raw values from <code>total_yards</code> and <code>total_points</code> and view the expected line of best fit.</p>
<div class="cell" data-layout-align="center" data-fig.dpi="400">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">regression_2022</span> <span class="op">&lt;-</span> <span class="va">simple_regression_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op">==</span> <span class="fl">2022</span><span class="op">)</span></span>
<span></span>
<span><span class="va">teams</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_teams.html">load_teams</a></span><span class="op">(</span>current <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regression_2022</span> <span class="op">&lt;-</span> <span class="va">regression_2022</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">teams</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"team"</span> <span class="op">=</span> <span class="st">"team_abbr"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="va">regression_2022</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">total_yards</span>, y <span class="op">=</span> <span class="va">total_points</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"black"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, size <span class="op">=</span> <span class="fl">.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_image</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>image <span class="op">=</span> <span class="va">team_logo_wikipedia</span><span class="op">)</span>, asp <span class="op">=</span> <span class="fl">16</span><span class="op">/</span><span class="fl">9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**Line of Best Fit: 2022 Season**"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"*Y = total_yards ~ total_points*"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytic with R*&lt;br&gt;Brad J. Congelio"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Total Yards"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Total Points"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="05-nfl-analytics-advanced-methods_files/figure-html/simple-linear-lobf-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>The plot shows that based on a simple regression between <code>total_yards</code> and <code>total_points</code> that several teams - like the Titans, Giants, Packers, Raiders, Jaguars, and the Chiefs - are fitted nearly perfectly with the regression line. Other teams, however, such as the Buccaneers and the Cowboys are well off this line of best fit. To further examine this relationship, we can pass the data into a proper simple linear regression model and start exploring the summary statistics.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">results_2022</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">total_points</span> <span class="op">~</span> <span class="va">total_yards</span>, data <span class="op">=</span> <span class="va">regression_2022</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using the <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> function, the <span class="math inline">\(Y\)</span> variable (the dependent) is <code>total_yards</code> and the <span class="math inline">\(X\)</span> variable (the predictor) is entered as <code>total_yards</code> with the argument that the <code>data</code> is coming from the <code>regression_2022</code> dataframe stored in the RStudio environment. We can view the results of the regression model by using the <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">results_2022</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = total_points ~ total_yards, data = regression_2022)

Residuals:
    Min      1Q  Median      3Q     Max 
-71.443 -22.334   1.157  19.145  68.080 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -225.03520   65.44927  -3.438  0.00174 ** 
total_yards    0.10341    0.01132   9.135  3.6e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 32.04 on 30 degrees of freedom
Multiple R-squared:  0.7356,    Adjusted R-squared:  0.7268 
F-statistic: 83.45 on 1 and 30 DF,  p-value: 3.599e-10</code></pre>
</div>
</div>
<p>While residuals are not the only summary statistics to examine in the results, they do provide a broad way to understand how the linear model performed. In this case, the residuals have a wide spread and an inconsistent deviation from zero. While the <code>median</code> residual value is the closest to zero at 1.157, it is still a bit too high to safely conclude that the model is making predictions that adequately reflect the actual values. Moreover, both tail ends of the residual values (<code>Min</code> and <code>Max</code>) are a large negative and positive number, respectively, which is a possible indication that both over- and underestimating a team’s <code>total_points</code> by statistically significant amount.</p>
<p>However, as mentioned in this chapter’s explanation of how to interpret residuals from a model’s summary statistics, the widespread and deviation from zero in the results is likely the result of numerous factors outside the model’s purview that occur in any one NFL game. To get a better idea of what the residual values represent, we can plot the data and include NFL team logos.</p>
<div class="cell" data-layout-align="center" data-fig.dpi="400">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">regression_2022</span><span class="op">$</span><span class="va">residuals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">results_2022</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">regression_2022</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">total_yards</span>, y <span class="op">=</span> <span class="va">residuals</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_fit_residuals</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_fit_deviations</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.75</span>, color <span class="op">=</span> <span class="va">regression_2022</span><span class="op">$</span><span class="va">team_color</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_image</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>image <span class="op">=</span> <span class="va">team_logo_wikipedia</span><span class="op">)</span>, asp <span class="op">=</span> <span class="fl">16</span><span class="op">/</span><span class="fl">9</span>, size <span class="op">=</span> <span class="fl">.0325</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**Total Yards &amp; Residual Values**"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"*Y = total_points ~ total_yards*"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytic with R*&lt;br&gt;Brad J. Congelio"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Total Yards"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Residual of Total Points"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.minor.y <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"#d0d0d0"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="05-nfl-analytics-advanced-methods_files/figure-html/plotting-residual-values-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>With the data visualized, it is clear that the model’s <code>Min</code> distribution of -71.44 is associated with the Tampa Bay Buccaneers, while the <code>Max</code> distribution of 68.08 is the prediction for the total points earned by the Dallas Cowboys. Because a negative residual means that the model’s predicted value is too high, and a positive residual means it was too low, we can conclude that the Buccaneers actually scored 71.4 points less than the the results of the model, while the Cowboys scored 68.08 more than predicted.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">`Coefficients:</span></span>
<span><span class="va">              Estimate Std. Error t value      Pr(&gt;|t|)    </span></span>
<span><span class="va">(Intercept) -225.03520   65.44927  -3.438       0.00174 ** </span></span>
<span><span class="va">total_yards    0.10341    0.01132   9.135 0.00000000036 ***</span></span>
<span><span class="va">---</span></span>
<span><span class="va">Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1`</span>˜.â€™ 0.1 â€˜ â€™ 1`</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>(Intercept)</code> of the model, or where the regression line crosses the y-axis, is -225.0350. When working with NFL data, it of course does not make sense that the <code>(Intercept)</code> is negative. Given the model is built on a team’s total yards and total points, it seems intuitive that the regression line would cross the y-axis at the point of (0,0) as an NFL team not gaining any yards is highly unlike to score any points.</p>
<p>It is important to remember that the linear model attempts to position the regression line to come as close to all the individual points as possible. Because of this, it is not uncommon for regression line to not cross exactly where the x-axis and y-axis meet. Again, contextual factors of an NFL game are not account for in the model’s data: strength of the opponent’s defense, the quality of special teams play, defensive turnovers and/or touchdowns, field position, etc. can all impact a team’s ability to score points without gaining any yardage. The lack of this information in the data ultimately impact the positioning of the line of best fit.</p>
<p>The <code>total_yards</code> coefficient represents the slope of the model’s regression line. It is this slope that represents how a team’s total points are predicted to change with every additional gain of one yard. In this example, the <code>total_yards</code> coefficient is 0.10341 - so for every additional yard gained by a team, it is expected to add 0.10341 points to the team’s cumulative amount.</p>
<p>The <code>Std. Error</code> summary statistic provides guidance on the accuracy of the other estimated coefficients. The <code>Std. Error</code> for the model’s <code>(Intercept)</code> is quite large at 65.44927. Given the ability to resample the data from NFL terms numerous times and then allowing the linear model to predict again, this specific <code>Std. Error</code> argues that the regression line will cross the y-axis with 65.44972 of -225.03520 in either direction. Under normal circumstances, a large <code>Std. Error</code> for the <code>(Intercept)</code> would cause concern about the validity of the regression line’s crossing point. However, given the nature of this data - an NFL team cannot score negative points - we should not have any significant concern about the large <code>Std. Error</code> summary statistic for the <code>(Intercept)</code>.</p>
<p>At 0.01132, the <code>Std. Error</code> for the <code>total_yards</code> coefficient is small and indicates that the <code>Estimate</code> of <code>total_yards</code> - that is, the increase in points per every yard gained - is quite accurate. Given repeated re-estimating of the data, the relationship between <code>total_yards</code> and <code>total_points</code> would vary by just 0.01132, either positively or negatively.</p>
<p>With a <code>t-value</code> of 9.135, the <code>total_yards</code> coefficient has a significant relationship with <code>total_points</code>. The A value of -3.438 indicates that the <code>(Intercept)</code> is statistically different from 0 but we should still largely ignore this relationship given the nature of the data.</p>
<p>The model’s <code>Pr(&gt;|t|)</code> value of highly significant for <code>total_yards</code> and is still quite strong for the <code>(Intercept)</code>. The value of 0.00000000036 indicates an incredibly significant relationship between <code>total_yards</code> and <code>total_points</code>.</p>
<p>The linear model’s <code>Residual Standard Error</code> is 32.04, which means that the average predicted values of <code>total_points</code> are 32.04 points different from the actual values in the data. The linear model was able to explain 73.56% of the variance between <code>total_yards</code> and <code>total_points</code> based on the <code>multiple R-squared</code> value of 0.7356. Additionally, the <code>Adjusted R-squared</code> value of 0.7268 is nearly identical to the multiple R2, which is a sign that the linear model is not overfitting (in this case because of the simplicity of the data). The model’s <code>F-Statistic</code> of 83.45 indicates a overall significance to the data, which is backed up by an extremely strong <code>p-value</code>.</p>
<p>Based on the summary statistics, the linear model did an extremely good job at capturing the relationship between a team’s <code>total_yards</code> and <code>total_points</code>. However, with residuals ranging from -71.443 to 68.080, it is likely that the model can be improved upon by adding additional information and statistics. However, before providing additional metrics, we can try to improve the model’s predictions by including all of the data (rather than just the 2022 season). By including 20-seasons worth of <code>total_yards</code> and <code>total_points</code>, we are increasing the sample size which, in theory, allows for a reduced impact of any outliers and an improve generalizability.</p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Working with 10+ years of play-by-play data can be problematic in that them model, using just <code>total_yards</code> and <code>total_points</code>, is not aware of changes in the overall style of play NFL. The balance between rushing and passing has shifted, there’s been a philosophical shift in the coaching ranks in “going for it” on 4th down, etc. A simple linear regression cannot account for how these shifts impact the data on a season-by-season basis.</p>
</div>
</div>
<p>The results from including the <code>total_points</code> and <code>total_yards</code> for each NFL team from 2012-2022 show an improvement of the model, specifically with the residual values.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">regression_all_seasons</span> <span class="op">&lt;-</span> <span class="va">simple_regression_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">season</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all_season_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">total_points</span> <span class="op">~</span> <span class="va">total_yards</span>, data <span class="op">=</span> <span class="va">regression_all_seasons</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">all_season_results</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Without further testing, the residual values after including 20-seasons worth of data are a bit better. The <code>Median</code> is -1.26 which is slightly higher than just one season (<code>M</code> = 1.16). The <code>1Q</code> and <code>3Q</code> distributions are both approximately symmetric around the model’s <code>M</code> value compared to just the 2022 season regression that results in a deviation between <code>1Q</code> and <code>3Q</code> (-22.33 and 19.15, respectively). The <code>Min</code> and <code>Max</code> values of the new model still indicate longtail cases on both ends of the regression line much like the 2022 model found.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>To further examine the residual values, we can use a <strong>Shapiro-Wilk Test</strong> to test the whether results are normally distributed.</p>
<p>The Shapiro-Wilk Test provides two values with the output: the test statistic (provided as a <code>W</code> score) and the model’s <code>p-value</code>. Scores for <code>W</code> can range between 0 and 1, where results closer to 1 meaning the residuals are in a normal distribution. The <code>p-value</code> is used make decision on the null hypothesis (that there <em>is</em> enough evidence to conclude that there is uneven distribution). In most cases, if the <code>p-value</code> is larger than the regression’s level of significance (typically 0.05), than you may <strong>reject</strong> the null hypothesis.</p>
<p>We can run the Shapiro-Wilk Test on our 2012-2022 data using the <code>shapiro.test</code> function that is part of the <code>stats</code> package in R.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">results_2012_2020</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">all_season_results</span><span class="op">)</span></span>
<span></span>
<span><span class="va">shapiro_test_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/shapiro.test.html">shapiro.test</a></span><span class="op">(</span><span class="va">results_2012_2020</span><span class="op">)</span></span>
<span></span>
<span><span class="va">shapiro_test_result</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  results_2012_2020
W = 0.99704, p-value = 0.7737</code></pre>
</div>
</div>
<p>The <code>W</code> score for the residual is 1, meaning a very strong indication that the data in our model is part of a normal distribution. The <code>p-value</code> is 0.8, which is much large than the regression’s level of significance (0.05). As a result, we can reject the null hypothesis and again conclude that the data is in a normal distribution.</p>
</div>
</div>
<p>Using the Shapiro-Wilk Test to confirm the normal distribution of the data is help because, if plotted, the model that covers 20-seasons worth of data is harder to visually interpret than just one season as the plot increases from just 32 data points to 640, with many overlapping.</p>
<div class="cell" data-layout-align="center" data-fig.dpi="400">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">teams</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_teams.html">load_teams</a></span><span class="op">(</span>current <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regression_all_seasons</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">regression_all_seasons</span>, <span class="va">teams</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"team"</span> <span class="op">=</span> <span class="st">"team_abbr"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regression_all_seasons</span><span class="op">$</span><span class="va">residuals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">all_season_results</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">regression_all_seasons</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">total_yards</span>, y <span class="op">=</span> <span class="va">residuals</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_fit_residuals</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="va">regression_all_seasons</span><span class="op">$</span><span class="va">team_color</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_fit_deviations</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="va">regression_all_seasons</span><span class="op">$</span><span class="va">team_color</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**Total Yards &amp; Residual Values: 2012-2022**"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"*Y = total_points ~ total_yards*"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytic with R*&lt;br&gt;Brad J. Congelio"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Total Yards"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Residual of Total Points"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.minor.y <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"#d0d0d0"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="05-nfl-analytics-advanced-methods_files/figure-html/plotting-all-season-residuals-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can also compare the multiple R2 and adjusted R2 score between the two regression models.</p>
<pre><code>2012 - 2022 Data:
Multiple R-squared:  0.683
Adjusted R-squared:  0.682

2022 Data
Multiple R-squared:  0.736
Adjusted R-squared:  0.727</code></pre>
<p>The regression using just the 2022 data results in a slightly better multiple and adjusted R2 score compared to using data from the last twenty seasons of the NFL. While this does indicate that the model based on the single season is better at defining the relationship between a team’s <code>total_yards</code> and <code>total_points</code> it is essential to remember that there is different underlying patterns in the data as a result of the changing culture in the NFL and, ultimately, the epp and flow of team performance as a result of high levels of parity in the league.</p>
<p>In order to account for this “epp and flow” in both team performance and the changing culture/rules of the NFL, we need to turn to a multiple linear regression in include these additional factors as it is a model that is capable of better accounting for the nuances of NFL data.</p>
</section><section id="multiple-linear-regression" class="level4" data-number="6.3.1.4"><h4 data-number="6.3.1.4" class="anchored" data-anchor-id="multiple-linear-regression">
<span class="header-section-number">6.3.1.4</span> Multiple Linear Regression</h4>
<p>A multiple linear regression is extremely similar to a simple linear regression (both in design and how to create one in RStudio). The main difference, as discussed, is that a multiple linear regression allows for us to include additional predictor variables by using the <code>+</code> sign in the model’s formula. The inclusion fo these additional predictive variables, in theory, allow the model to compute the more complex relationships in NFL data and improve its final performance.</p>
<p>We will again create our first multiple linear regression with just data from the 2022 season that includes the same predictor (<code>total_yards</code>) and response variable (<code>total_points</code>). For additional predictors, we must consider what circumstances may lead a team to have high <code>total_yardage</code> but an amount of <code>total_points</code> that would fall below the model’s predicted value. We will include as additional predictors:</p>
<ol type="1">
<li>
<strong>Redzone Efficiency:</strong> provided as a percentage, this is a calculation of how many times a team drove into the red zone and scored. A higher percentage is better.</li>
<li>
<strong>Redzone Touchdown Efficiency:</strong> This is the same as redzone efficiency, but includes only the number of red zone trips divided by the total touchdowns scored from the redzone.</li>
<li>
<strong>Redzone Field Goal Efficiency:</strong> The same as redzone touchdown efficiency, but with field goals.</li>
<li>
<strong>Cumulative Turnovers</strong>: The total number of turnovers during the regular season.</li>
<li>
<strong>Defensive Touchdowns</strong>: The number of touchdowns scored by each team’s defensive unit.</li>
<li>
<strong>Special Teams Touchdowns</strong>: The number of touchdowns scored by special teams (kick/punt returns).</li>
</ol>
<p>Let’s build the multiple regression model for only the 2022 season. You can read in the data using <code><a href="https://vroom.r-lib.org/reference/vroom.html">vroom::vroom</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">multiple_lm_data</span> <span class="op">&lt;-</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/bcongelio/nfl-analytics-with-r-book/origin/example_data/csv/multiple_lm_data.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">multiple_lm_data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data for the multiple linear regression has the same four columns as the simple linear regression (<code>season</code>, <code>team</code>, <code>total_points</code>, and <code>total_yards</code>). After are the new additional predictors (<code>rz_eff</code>, <code>rz_td_eff</code>, <code>rz_fg_eff</code>, <code>def_td</code>, and <code>spec_tds</code>).</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Danger
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please note that, of the predictor and response variables, all of the values are in whole number format except for <code>rz_eff</code>, <code>rz_td_eff</code>, and <code>rz_fg_eff</code>. While it is not a problem to include predictors that are on differing scales (in this case, whole numbers and percentages), it may cause difficulty in interpreting the summary statistics. If this is the case, the issue can be resolved by using the <code><a href="https://rdrr.io/r/base/scale.html">scale()</a></code> function to standardize all the data’s predictors against one another.</p>
</div>
</div>
<p>The construction of the multiple linear regression is the same process of the simple linear regression, with the inclusion of additional predictors to the formula using the <code>+</code> sign. We are applying a <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> to our <code>multiple_lm_data</code> to retrieve just the 2022 season to begin.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">multiple_lm_2022</span> <span class="op">&lt;-</span> <span class="va">multiple_lm_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op">==</span> <span class="fl">2022</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">lm_multiple_2022</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">total_points</span> <span class="op">~</span> <span class="va">total_yards</span> <span class="op">+</span> <span class="va">rz_eff</span> <span class="op">+</span> <span class="va">rz_td_eff</span> <span class="op">+</span></span>
<span>                         <span class="va">rz_fg_eff</span> <span class="op">+</span> <span class="va">total_to</span> <span class="op">+</span> <span class="va">def_td</span> <span class="op">+</span> <span class="va">spec_tds</span>, data <span class="op">=</span> <span class="va">multiple_lm_2022</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">lm_multiple_2022</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = total_points ~ total_yards + rz_eff + rz_td_eff + 
    rz_fg_eff + total_to + def_td + spec_tds, data = multiple_lm_2022)

Residuals:
    Min      1Q  Median      3Q     Max 
-53.035 -15.584  -0.353  14.603  43.528 

Coefficients: (1 not defined because of singularities)
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -459.52248  128.55567  -3.575  0.00146 ** 
total_yards    0.09056    0.01129   8.020 2.25e-08 ***
rz_eff       228.88531  113.56255   2.016  0.05472 .  
rz_td_eff    167.23235   82.70971   2.022  0.05401 .  
rz_fg_eff           NA         NA      NA       NA    
total_to       0.40582    1.49339   0.272  0.78805    
def_td         4.45597    4.05728   1.098  0.28255    
spec_tds       5.49769    7.86741   0.699  0.49113    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 26.94 on 25 degrees of freedom
Multiple R-squared:  0.8442,    Adjusted R-squared:  0.8068 
F-statistic: 22.57 on 6 and 25 DF,  p-value: 5.807e-09</code></pre>
</div>
</div>
<p>The summary statistic residuals for the multiple linear regression are more evenly distributed towards the mean than our simple linear regression. Based on the residuals, we can conclude that - for 50% of the teams - the model either over or underestimated their <code>total_points</code> by just -0.35 (as listed in the <code>Median</code> residual). The interquartile range (within the <code>1Q</code> and <code>3Q</code> quartiles) are both close to the median and the <code>Min</code> and <code>Max</code> residuals both decreased significantly from our simple linear model, indicating a overall better line of fit.</p>
<p>We can confirm that the multiple linear regression resulted in an even distribution of the residuals by again using a Shapiro-Wilk’s Test.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  results_lm_2022
W = 0.98378, p-value = 0.8989</code></pre>
</div>
</div>
<p>The results of the Shapiro-Wilk’s test (<code>W = 1</code> and <code>p-value = 0.9</code>) confirm that residuals are indeed evenly distributed. A visualization showcases the model’s even distribution of the residuals.</p>
<div class="cell" data-layout-align="center" data-fig.dpi="400">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### gathering the fitted numbers and residual numbers</span></span>
<span><span class="va">mlm_2022_fitted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">lm_multiple_2022</span><span class="op">)</span></span>
<span><span class="va">mlm_2022_residuals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">lm_multiple_2022</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### binding them into a data frame</span></span>
<span><span class="va">plot_data_2022</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Fitted <span class="op">=</span> <span class="va">mlm_2022_fitted</span>, Residuals <span class="op">=</span> <span class="va">mlm_2022_residuals</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### c binding teams</span></span>
<span><span class="va">plot_data_2022</span> <span class="op">&lt;-</span> <span class="va">plot_data_2022</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">teams</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### plotting</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_data_2022</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Fitted</span>, y <span class="op">=</span> <span class="va">Residuals</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_hline</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_fit_deviations</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.75</span>, color <span class="op">=</span> <span class="va">plot_data_2022</span><span class="op">$</span><span class="va">team_color</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_image</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>image <span class="op">=</span> <span class="va">team_logo_espn</span><span class="op">)</span>, asp <span class="op">=</span> <span class="fl">16</span><span class="op">/</span><span class="fl">9</span>, size <span class="op">=</span> <span class="fl">.0325</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_y_continuous</span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"**Multiple Linear Regression Model: 2022**"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"*An Introduction to NFL Analytic with R*&lt;br&gt;Brad J. Congelio"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Fitted Values"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Residual Values"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>panel.grid.minor.y <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"#d0d0d0"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="05-nfl-analytics-advanced-methods_files/figure-html/multiple-regression-plot-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Just as the residual values in the summary statistics indicated, plotting the <code>fitted_values</code> against the <code>residual_values</code> shows an acceptable spread in the distribution, especially given the nature of NFL data. Despite positive results in the residual values, the summary statistics of the mulitple linear regression indicates a significant issue with the data. Within the <code>Coefficients</code>, it is explained that one of the items is “not defined because of singularities.”</p>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>“Singularities” occur in the data as a result of the dreaded multicollinearity between two or more predictors. The involved predictors were found to have a high amount of correlation between one another, meaning <strong>that one of the variables can be predicted in a near linear fashion with one or more of the other predictive variables</strong>. As a result, it is difficult for the regression model to correctly estimate the contribution of these dependent variables to the response variable.</p>
<p>The model’s Coefficients of our multiple linear regression shows <code>NA</code> values for the <code>rz_fg_eff</code> predictor (the percentage of times a team made a field goal in the red zone rather than a touchdown). This is because <code>rz_fg_eff</code> was one of the predictive variables strongly correlated with another but just that it was the one dropped by the regression model to avoid producing flawed statistics as a result of the multicollinearity.</p>
<p><strong>If you are comfortable producing the lienar regression with <code>rz_fg_eff</code></strong> <strong>being a dropped predictor, that are no issues with that</strong>. However, we can create a correlation plot that allows is to determine which predictors have high correlation values with others. Examining the issue allows us to determine if <code>rz_fg_eff</code> is, indeed, the predictive variable we want the regression to drop or if we’d rather, for example, drop <code>rz_eff</code> and keep just the split between touchdowns and field goals.</p>
<div class="cell" data-layout-align="center" data-fig.dpi="400">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">regression_corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">multiple_lm_2022</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"total_yards"</span>, <span class="st">"rz_eff"</span>, <span class="st">"rz_td_eff"</span>,</span>
<span>                                            <span class="st">"rz_fg_eff"</span>, <span class="st">"total_to"</span>, <span class="st">"def_td"</span>, <span class="st">"spec_tds"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### melting the regression_corr to prep for ggplot</span></span>
<span><span class="va">melted_regression_corr</span> <span class="op">&lt;-</span> <span class="fu">melt</span><span class="op">(</span><span class="va">regression_corr</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## plotting</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">melted_regression_corr</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Var1</span>, y <span class="op">=</span> <span class="va">Var2</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_tile</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_distiller</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"PuBu"</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Var1</span>, y <span class="op">=</span> <span class="va">Var2</span>, label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">value</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>            fontface <span class="op">=</span> <span class="st">"bold"</span>, family <span class="op">=</span> <span class="st">"Roboto Condensed"</span>, size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Multicollinearity Correlation Matrix"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Multiple Linear Regression: 2022 Data"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"**An Introduction to NFL Analytics with R**&lt;br&gt;Brad J. Congelio"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Correlation \n Measure"</span>, x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#F7F7F7"</span><span class="op">)</span>,</span>
<span>        legend.key <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"#F7F7F7"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="05-nfl-analytics-advanced-methods_files/figure-html/building-corr-matrix-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Using a correlation plot allows for easy identification of those predictive variables that have high correlation with one another. <strong>The general rule is that two predictors become problematic in the regression model in the coefficient between the two is above 0.7 (0.8, given domain knowledge about the context of the data)</strong>.</p>
<p>In our correlation plot, there are two squares in (indicated by the darkest blue color) that have a value greater than 0.7 (or -0.7 in this case, as both strong and negative correlations are capable of producing multicollinearity. The two squares happen to relate to the same relationship between the <code>rz_fg_eff</code> and <code>rz_td_eff</code> predictors.</p>
<p>Recall that the regression model automatically removed the <code>rz_fg_eff</code> from the measured Coefficients. Given the context of the data, I am not sure that is the best decision. Given we are examining the relationship the predictive variables and <code>total_points</code>, removing the <code>rz_fg_eff</code> variable inherently erases a core source of points in a game of football.</p>
<p>Because of this - and since our <code>rz_eff</code> predictor accounts for <em>both</em> touchdowns and field goals - I believe we could move forward on rerunning the regression without either <code>rz_fg_eff</code> and <code>rz_td_eff</code>.</p>
</div>
</div>
<p>To run the multiple linear regression again, without the predictors relating to red zone touchdown and field efficiency, we will drop both from our <code>multiple_lm_2022</code> dataframe, rerun the regression model, and then examine the ensuing summary statistics.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">multiple_lm_2022_edit</span> <span class="op">&lt;-</span> <span class="va">multiple_lm_2022</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">rz_td_eff</span>, <span class="op">-</span><span class="va">rz_fg_eff</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_multiple_2022_edit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">total_points</span> <span class="op">~</span> <span class="va">total_yards</span> <span class="op">+</span> <span class="va">rz_eff</span> <span class="op">+</span></span>
<span>                         <span class="va">total_to</span> <span class="op">+</span> <span class="va">def_td</span> <span class="op">+</span> <span class="va">spec_tds</span>, data <span class="op">=</span> <span class="va">multiple_lm_2022_edit</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">lm_multiple_2022_edit</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = total_points ~ total_yards + rz_eff + total_to + 
    def_td + spec_tds, data = multiple_lm_2022_edit)

Residuals:
    Min      1Q  Median      3Q     Max 
-60.176 -14.830  -3.786  18.990  55.917 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -472.58766  135.80424  -3.480  0.00178 ** 
total_yards    0.09977    0.01093   9.129 1.37e-09 ***
rz_eff       309.11667  112.54620   2.747  0.01079 *  
total_to      -0.27596    1.53880  -0.179  0.85907    
def_td         3.58077    4.26698   0.839  0.40902    
spec_tds       4.95838    8.31675   0.596  0.55620    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 28.5 on 26 degrees of freedom
Multiple R-squared:  0.8187,    Adjusted R-squared:  0.7838 
F-statistic: 23.48 on 5 and 26 DF,  p-value: 7.028e-09</code></pre>
</div>
</div>
<p>We have certainly simplified the model by removing both <code>rz_td_eff</code> and <code>rz_fg_eff</code> but the impact of this change is a fair trade off, it seems, to avoid further issues with multicollinearity. Our new adjusted R is still high (0.784), only dropping a bit from the original model that included both predictors (0.807). Both models did well at explaining the amount of variance between the predictors and the response variable. While the <code>F-statistic</code> and the <code>p-value</code> are strong in both models, it is important to note that the <code>Residual standard error</code> dropped from 27 in the original model to 28 in the more simplified version. Given that this value is the average difference between the data’s actual values and the predicted equivalents in the regression, both would ideally be smaller.</p>
<p>With multiple linear regression model producing acceptable results over the course of the 2022 season, we can now see if the results remain stable when produced from the course of 2012-2022.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">multiple_lm_data_all</span> <span class="op">&lt;-</span> <span class="va">multiple_lm_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">rz_td_eff</span>, <span class="op">-</span><span class="va">rz_fg_eff</span>, <span class="op">-</span><span class="va">season</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_multiple_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">total_points</span> <span class="op">~</span> <span class="va">total_yards</span> <span class="op">+</span> <span class="va">rz_eff</span> <span class="op">+</span></span>
<span>                              <span class="va">total_to</span> <span class="op">+</span> <span class="va">def_td</span> <span class="op">+</span> <span class="va">spec_tds</span>, data <span class="op">=</span> <span class="va">multiple_lm_data_all</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">lm_multiple_all</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = total_points ~ total_yards + rz_eff + total_to + 
    def_td + spec_tds, data = multiple_lm_data_all)

Residuals:
    Min      1Q  Median      3Q     Max 
-70.483 -21.187  -1.671  19.644  81.849 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -3.227e+02  3.430e+01  -9.408  &lt; 2e-16 ***
total_yards  8.686e-02  2.944e-03  29.500  &lt; 2e-16 ***
rz_eff       2.643e+02  3.558e+01   7.429 8.65e-13 ***
total_to    -2.068e+00  3.004e-01  -6.884 2.75e-11 ***
def_td       9.701e+00  9.715e-01   9.986  &lt; 2e-16 ***
spec_tds    -9.847e-01  1.933e+00  -0.509    0.611    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 29.51 on 346 degrees of freedom
Multiple R-squared:  0.821, Adjusted R-squared:  0.8184 
F-statistic: 317.4 on 5 and 346 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>The results of the multiple linear regression over data from the 2012-2022 indicates a statistically significant relationship between our predictor variables and a team’s total yards. That said, two items are worth further exploration.</p>
<ol type="1">
<li>
<p>The model’s Residual standard error increased to 30, as opposed to the values of 27 and 28 from the models built on a single season of data. This means that the model, on average, is over or underpredicting the actual values by 30 total points. To verify that a residual standard error of 30 is not too high given the nature of our data, we can need to evaluate its value against the scale of our data based on the mean and/or median averages of the <code>total_points</code> variable. As seen below, the model’s RSE as a percentage of the mean is <code>8.1%</code> and its percentage of the median is <code>8.2%</code>. Given that both values are below 10%, it is reasonable to conclude that the value of the model’s residual standard error is statistically small compared to the scale of the <code>total_points</code> dependent variable.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">total_mean_points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">multiple_lm_data_all</span><span class="op">$</span><span class="va">total_points</span><span class="op">)</span></span>
<span><span class="va">total_points_median</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">multiple_lm_data_all</span><span class="op">$</span><span class="va">total_points</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rse_mean_percentage</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">30</span> <span class="op">/</span> <span class="va">total_mean_points</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span><span class="va">rse_median_percentage</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">30</span> <span class="op">/</span> <span class="va">total_points_median</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</li>
<li><p>The <code>spec_tds</code> predictor, which is the total number of special teams touchdowns scored by a team, has a <code>p-value</code> of 0.61. This high of a <code>p-value</code> indicates that the amount of special teams touchdowns earned by a team is not a dependable predictor of the team’s total points. Given the rarity of kickoff and punt returns, it is not surprising that the predictor returned a high <code>p-value</code>. If we run the regression again, without the <code>spec_tds</code> predictive variable, we get results that are nearly identical to the regression model that includes it as a predictor. The only significant difference is a decrease in the <code>F-statistic</code> from 398 to 317. Given the small decrease, we will keep <code>spec_tds</code> in the model.</p></li>
</ol>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The final step of our multiple linear regression model is feeding it new data to make predictions on.</p>
<p>To begin, we need to create a new dataframe that holds the new predictor variables. For nothing more than fun, let’s grab the highest value from each predictive variable between the 2012-2022 season.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">new_observations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  total_yards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">multiple_lm_data</span><span class="op">$</span><span class="va">total_yards</span><span class="op">)</span>,</span>
<span>  rz_eff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">multiple_lm_data</span><span class="op">$</span><span class="va">rz_eff</span><span class="op">)</span>,</span>
<span>  total_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">multiple_lm_data</span><span class="op">$</span><span class="va">total_to</span><span class="op">)</span>,</span>
<span>  def_td <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">multiple_lm_data</span><span class="op">$</span><span class="va">def_td</span><span class="op">)</span>,</span>
<span>  spec_tds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">multiple_lm_data</span><span class="op">$</span><span class="va">spec_tds</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This hypothetical team gained a total of 7,317 yards in one season and was incredibly efficient in the red zone, scoring 96% of the time. It also scored nine defensive touchdowns and returned a punt or a touchdown to the house four times. Unfortunately, the offense also turned the ball over a whopping total of 41 times.</p>
<p>We can now pass this information into our existing model using the <code>predict</code> function and it will output the predicted <code>total_points</code> earned by this hypothetical team based on the multiple linear regression model we built with 20 years of NFL data.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">new_predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">lm_multiple_all</span>, newdata <span class="op">=</span> <span class="va">new_observations</span><span class="op">)</span></span>
<span></span>
<span><span class="va">new_predictions</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model determined, based on the new predictor variables provided, that this hypothetical team will score a total of 566 points, which is the second-highest cumulative amount scored by a team dating back to the 2012 season (the 2013 Denver Broncos scored 606 total points). In this situation, the hypothetical team has nearly double the turnovers as the 2013 Bronco (41 turnovers to 21). It is reasonable that providing this hypothetical team a lower number of turnovers would result in it becoming the highest scoring team since 2012.</p>
</div>
</div>
</section></section><section id="logistic-regressions" class="level3" data-number="6.3.2"><h3 data-number="6.3.2" class="anchored" data-anchor-id="logistic-regressions">
<span class="header-section-number">6.3.2</span> Logistic Regressions</h3>
<p>introduction to logistic regressions here.</p>
<section id="binary-classification" class="level4" data-number="6.3.2.1"><h4 data-number="6.3.2.1" class="anchored" data-anchor-id="binary-classification">
<span class="header-section-number">6.3.2.1</span> Binary Classification</h4>
<p>examples of binary classification here using nfl data.</p>
</section><section id="multiclass-classification" class="level4" data-number="6.3.2.2"><h4 data-number="6.3.2.2" class="anchored" data-anchor-id="multiclass-classification">
<span class="header-section-number">6.3.2.2</span> Multiclass Classification</h4>
<p>examples of multiclass classification here using nfl data.</p>
</section></section></section><section id="advanced-regression-techniques" class="level2" data-number="6.4"><h2 data-number="6.4" class="anchored" data-anchor-id="advanced-regression-techniques">
<span class="header-section-number">6.4</span> Advanced Regression Techniques</h2>
<section id="regularization" class="level3" data-number="6.4.1"><h3 data-number="6.4.1" class="anchored" data-anchor-id="regularization">
<span class="header-section-number">6.4.1</span> Regularization</h3>
<p>intro to regularization techniques here.</p>
<section id="ridge-regression" class="level4" data-number="6.4.1.1"><h4 data-number="6.4.1.1" class="anchored" data-anchor-id="ridge-regression">
<span class="header-section-number">6.4.1.1</span> Ridge Regression</h4>
<p>examples of ridge regression using nfl data.</p>
</section><section id="lasso-regression" class="level4" data-number="6.4.1.2"><h4 data-number="6.4.1.2" class="anchored" data-anchor-id="lasso-regression">
<span class="header-section-number">6.4.1.2</span> Lasso Regression</h4>
<p>examples of lasso regression using nfl data.</p>
</section><section id="elastic-ridge-regression" class="level4" data-number="6.4.1.3"><h4 data-number="6.4.1.3" class="anchored" data-anchor-id="elastic-ridge-regression">
<span class="header-section-number">6.4.1.3</span> Elastic Ridge Regression</h4>
<p>examples of elastic ridge regression using nfl data.</p>
</section></section><section id="generalized-linear-and-additive-models-glmgam" class="level3" data-number="6.4.2"><h3 data-number="6.4.2" class="anchored" data-anchor-id="generalized-linear-and-additive-models-glmgam">
<span class="header-section-number">6.4.2</span> Generalized Linear and Additive Models (GLM/GAM)</h3>
<p>intro to both GLM and GAM here.</p>
<section id="poisson-regression-glm" class="level4" data-number="6.4.2.1"><h4 data-number="6.4.2.1" class="anchored" data-anchor-id="poisson-regression-glm">
<span class="header-section-number">6.4.2.1</span> Poisson Regression (GLM)</h4>
<p>example of poisson regression using nfl data.</p>
</section><section id="polynominal-regressiongam" class="level4" data-number="6.4.2.2"><h4 data-number="6.4.2.2" class="anchored" data-anchor-id="polynominal-regressiongam">
<span class="header-section-number">6.4.2.2</span> Polynominal Regression(GAM)</h4>
<p>example of polynominal regression using nfl data.</p>
</section></section></section><section id="advanced-modeling-techniques" class="level2" data-number="6.5"><h2 data-number="6.5" class="anchored" data-anchor-id="advanced-modeling-techniques">
<span class="header-section-number">6.5</span> Advanced Modeling Techniques</h2>
<p>introduction to advanced modeling techniques in the nfl.</p>
<section id="clustering" class="level3" data-number="6.5.1"><h3 data-number="6.5.1" class="anchored" data-anchor-id="clustering">
<span class="header-section-number">6.5.1</span> Clustering</h3>
<p>introduction to clustering.</p>
<section id="k-means-clustering" class="level4" data-number="6.5.1.1"><h4 data-number="6.5.1.1" class="anchored" data-anchor-id="k-means-clustering">
<span class="header-section-number">6.5.1.1</span> K-means Clustering</h4>
<p>examples of k-means clustering here.</p>
</section><section id="hierarchical-clustering" class="level4" data-number="6.5.1.2"><h4 data-number="6.5.1.2" class="anchored" data-anchor-id="hierarchical-clustering">
<span class="header-section-number">6.5.1.2</span> Hierarchical Clustering</h4>
<p>examples of hierarchical clustering here.</p>
</section></section><section id="decision-treesrandom-forests" class="level3" data-number="6.5.2"><h3 data-number="6.5.2" class="anchored" data-anchor-id="decision-treesrandom-forests">
<span class="header-section-number">6.5.2</span> Decision Trees/Random Forests</h3>
<p>introduction to decision trees/random forests in nfl data.</p>
<section id="classification-trees" class="level4" data-number="6.5.2.1"><h4 data-number="6.5.2.1" class="anchored" data-anchor-id="classification-trees">
<span class="header-section-number">6.5.2.1</span> Classification Trees</h4>
<p>example of classification tree using nfl data.</p>
</section><section id="regression-trees" class="level4" data-number="6.5.2.2"><h4 data-number="6.5.2.2" class="anchored" data-anchor-id="regression-trees">
<span class="header-section-number">6.5.2.2</span> Regression Trees</h4>
<p>example of regression tree using nfl data.</p>
</section></section></section><section id="creating-our-own-rushing-yards-over-expected-model" class="level2" data-number="6.6"><h2 data-number="6.6" class="anchored" data-anchor-id="creating-our-own-rushing-yards-over-expected-model">
<span class="header-section-number">6.6</span> Creating Our Own Rushing Yards Over Expected Model</h2>
<p>Back in January of 2021, Tej Seth posted an article to the <a href="https://mfootballanalytics.com/2021/01/14/creating-a-public-expected-rushing-yards-model/">Michigan Football Analytics Society blog</a> that outlined his vision for creating a “public expected rushing yards model.” The structure of his model, as explained by Tej, was inspired by the prior work of Michael Egle, an honorable mention in both the 2021 and 2023 NFL Big Data Bowl, who previously used the college football equivalent of open-source data (<a href="https://cfbfastr.sportsdataverse.org/"><code>cfbfastR</code></a>) to create an RYOE model for the collegiate game.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> In Tej’s case, his approach to created an NFL-centric RYOE model culminated with the creation of his <a href="https://mfbanalytics.shinyapps.io/RYOE/">RYOE Shiny App</a> that allows anybody to explore his RYOE metric by season or team and even through three-way rusher comparisons.</p>
<p>Despite a slightly intimidating title, rushing yards over expected is a fantastic entrypoint into exploring model creation and analysis in NFL analytics - in fact, the growing number of “over expected” metrics in the NFL are all great ways to begin learning about and understanding advanced modeling. Robby Greerre, the owner of <a href="https://www.nfeloapp.com/">nfeloapp.com</a> - a website that provides “data-driven analytics, picks, and predictions for the NFL” - explains that over expected metrics are a increasingly popular avenue in which analysts can “paint a more accurate picture of performance by adjusting familiar statistics like ‘completion percentage’ or ‘yards per rush’ for conflating factors like degree of difficulty or game text” <span class="citation" data-cites="nfelo">(<a href="references.html#ref-nfelo" role="doc-biblioref">Greerre 2022</a>)</span>.</p>
<p>Some of these metrics, like completion percentage over expected (CPOE), are widely accepted. Specifically, CPOE calculates how likely any quarterback’s pass is going to be complete or incomplete compared to other passing attempts. It is considered “widely accepted” because the metric itself is considered “stable” in that the r-squared value retains a strong correlation for individual quarterbacks across several seasons. In fact, as Greerre points out, the r-squared value for CPOE for just one season is 0.226 which is extremely strong based on NFL analytics standards.</p>
<p>On the other hand, RYOE - based on Greerre’s analysis - maintains an r-squared value below 0.15 until a running back’s fourth season, wherein the average improves to 0.263 (an otherwise stable value). But that does not mean that RYOE is not a metric worth further exploration. The effectiveness of any one metric to account for factors such as degree of difficulty or game text largely relies on our ability to provide adequate feature engineering - specifically, how much relevant data the machine learning model can ingest to begin making predictions.</p>
<p>Because of that, significant machine learning models have been built with information provided by the NFL’s Big Data Bowl as it is the one chance that the public receives to feature engineer with the NFL’s tracking data (wherein a player’s position, speed, direction, etc. is tracked and recorded every 1/10th of a second). Unfortunately, only small windows of data exist from the Big Data Bowl releases and, as a result, we are often required to find creative ways to provide further context to each play/player for the machine learning model.</p>
<p>To showcase this idea, we are going to begin exploring ways to add additional feature engineering to Tej Seth’s already fantastic Rushing Yard Over Expected model. While not the most stable metric, as mentioned, the idea of RYOE is generally easy to understand for even the most analyst. Broadly, given what we know about every other rushing play during a specific span of seasons, what is the most likely amount of yards a running back is going to gain on a specific rushing play as predicted by the model on other similar situations?</p>
<p><strong>That difference is rushing yards over expected</strong>.</p>
<p>Using Tej’s Shiny app, we can explore all seasons between 2015 and 2022 for those running backs that had a minimum of 755 rushing attempts.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="images/ryoe_2015_2022.jpg" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption class="figure-caption">Credit: Tej Seth</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>According to Tej’s model, since 2015, Nick Chubb of the Cleveland Browns earned - on average - 0.66 over expected. Aaron Jones is closely behind with 0.61 over expected and then a significant drop occurs for the third and fourth players.</p>
<p>To understand how Tej engineered his model and to begin exploring other possible features to feed into the model, we can dive into his <a href="https://github.com/tejseth/RYOE/blob/main/ryoe-2.R">publicly available code</a>.</p>
<section id="tej-seths-ryoe-model-under-the-hood" class="level3" data-number="6.6.1"><h3 data-number="6.6.1" class="anchored" data-anchor-id="tej-seths-ryoe-model-under-the-hood">
<span class="header-section-number">6.6.1</span> Tej Seth’s RYOE Model: Under The Hood</h3>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is important to immediately point out that Tej built his RYOE model using the <code>xgboost</code> package whereas we will begin constructing ours using <code>tidymodels</code>.</p>
<p>While the underlying eXtreme Gradient Boosting process is largely the same with both approaches, the necessary framework we will construct with <code>tidymodels</code> differs <em>greatly</em> from the coding used with the <code>xgboost</code> package.</p>
<p>The <code>xgboost</code> package is a standalone package in R that provide an implementation of the eXtreme Gradient Boosting algorithm. To that end, it offers a highly efficient and flexible way to train gradient boosting models for various machine learning tasks, such as classification, regression, and ranking. The package provides its own set of functions for training, cross-validation, prediction, and feature importance evaluation.</p>
<p>The <code>tidymodels</code> package, on the other hand, is a <em>collection</em> of R packages that provide a unified framework for modeling and machine learning tasks. It includes several package for data preprocessing, modeling, validation, and evaluation. Because of this, the core goal of the <code>tidymodels</code> teams is to offer a consistent syntax and workflow for a wide range of machine learning models. It is a fair comparison to say that <code>tidymodels</code> is the <code>tidyverse</code> of the machine learning world.</p>
</div>
</div>
<p>Just like the model we will be building in this chapter, Tej constructed his model via eXtreme Gradient Boosting.</p>
<p>Which may lead to a very obvious question if you are new to machine learning: <strong>what exactly <em>is</em> eXtreme Gradient Boosting?</strong></p>
</section><section id="extreme-gradient-boosting-explained" class="level3" data-number="6.6.2"><h3 data-number="6.6.2" class="anchored" data-anchor-id="extreme-gradient-boosting-explained">
<span class="header-section-number">6.6.2</span> eXtreme Gradient Boosting Explained</h3>
<p>eXtreme Gradient Boosting (XGBoost) is a powerful machine learning technique that is particularly good at solving supervised machine learning problems, such as classification (categorizing data into classes, for example) and regression (predicting numerical values).</p>
<p>XGBoost can be thought of as an “expert team” that combines the knowledge and skills of multiple “individual experts” to make better decisions or predictions. Each of these “experts” in this context is what we call a decision tree, which is a flowchart structure used for making decisions based on a series of question about the data.</p>
<p>Once provided data, XGBoost seeks to iteratively build a collection of “bad” decision trees and then build an ensemble of these poor ones into a more accurate and robust model. The term “gradient” comes from the fact that the algorithm uses the gradient (or the slope) of the loss function (a measure of how well the model fits the data) to guide the learning process.</p>
</section></section><section id="building-a-ryoe-model-with-tidymodels" class="level2" data-number="6.7"><h2 data-number="6.7" class="anchored" data-anchor-id="building-a-ryoe-model-with-tidymodels">
<span class="header-section-number">6.7</span> Building a RYOE Model with <code>tidymodels</code>
</h2>
<p>Place holding for the tidymodels code below.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://nflverse.nflverse.com/">nflverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tune.tidymodels.org/">tune</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">bon</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>scipen <span class="op">=</span> <span class="fl">999</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### reading in NFL play-by-play data from 2016 to 2022</span></span>
<span><span class="va">pbp</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_pbp.html">load_pbp</a></span><span class="op">(</span><span class="fl">2016</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### filtering to just rushing attempts that are not missing any yards_gained</span></span>
<span><span class="va">rush_attempts</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">rush_attempt</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">qb_scramble</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>         <span class="va">qb_dropback</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">yards_gained</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">### quickly calculating each defteam's avg. rushing yards allowed per season</span></span>
<span><span class="va">def_ypc</span> <span class="op">&lt;-</span> <span class="va">rush_attempts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">defteam</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">defteam</span>, <span class="va">season</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>def_ypc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">yards_gained</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### joining the defteam avg yards gained into the rushing data</span></span>
<span><span class="va">rush_attempts</span> <span class="op">&lt;-</span> <span class="va">rush_attempts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">def_ypc</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"defteam"</span>, <span class="st">"season"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### gathering offensive formation, offensive personnel, defensive personnel, and defenders in box</span></span>
<span><span class="va">participation</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_participation.html">load_participation</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2016</span><span class="op">:</span><span class="fl">2022</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">nflverse_game_id</span>, <span class="va">play_id</span>, <span class="va">possession_team</span>, <span class="va">offense_formation</span>,</span>
<span>         <span class="va">offense_personnel</span>, <span class="va">defense_personnel</span>, <span class="va">defenders_in_box</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### merging participation data into our rushing attempts data</span></span>
<span><span class="co">### note: the team match is likely not necessary but I was being careful</span></span>
<span><span class="va">rush_attempts</span> <span class="op">&lt;-</span> <span class="va">rush_attempts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">participation</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"game_id"</span> <span class="op">=</span> <span class="st">"nflverse_game_id"</span>,</span>
<span>                                  <span class="st">"play_id"</span> <span class="op">=</span> <span class="st">"play_id"</span>,</span>
<span>                                  <span class="st">"posteam"</span> <span class="op">=</span> <span class="st">"possession_team"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### creating a secondary dataframe for joining back in player names</span></span>
<span><span class="va">rushing_data_join</span> <span class="op">&lt;-</span> <span class="va">rush_attempts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">game_id</span>, <span class="va">rusher</span>, <span class="va">fixed_drive</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>drive_rush_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">rush_attempt</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">game_id</span>, <span class="va">rusher</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>game_rush_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">rush_attempt</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rush_prob <span class="op">=</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">xpass</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>,</span>
<span>         strat_score <span class="op">=</span> <span class="va">rush_prob</span> <span class="op">/</span> <span class="va">defenders_in_box</span>,</span>
<span>         wp <span class="op">=</span> <span class="va">wp</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>red_zone <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">yardline_100</span> <span class="op">&lt;=</span> <span class="fl">20</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>         fg_range <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">yardline_100</span> <span class="op">&lt;=</span> <span class="fl">35</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>         two_min_drill <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">half_seconds_remaining</span> <span class="op">&lt;=</span> <span class="fl">120</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">yards_gained</span>, <span class="va">season</span>, <span class="va">week</span>, <span class="va">yardline_100</span>, <span class="va">quarter_seconds_remaining</span>,</span>
<span>         <span class="va">half_seconds_remaining</span>, <span class="va">qtr</span>, <span class="va">down</span>, <span class="va">ydstogo</span>, <span class="va">shotgun</span>, <span class="va">no_huddle</span>,</span>
<span>         <span class="va">ep</span>, <span class="va">wp</span>, <span class="va">drive_rush_count</span>, <span class="va">game_rush_count</span>, <span class="va">red_zone</span>, <span class="va">fg_range</span>, <span class="va">two_min_drill</span>,</span>
<span>         <span class="va">offense_formation</span>, <span class="va">offense_personnel</span>, <span class="va">defense_personnel</span>, <span class="va">defenders_in_box</span>,</span>
<span>         <span class="va">rusher</span>, <span class="va">rush_prob</span>, <span class="va">def_ypc</span>, <span class="va">strat_score</span>, <span class="va">rusher_player_id</span>, <span class="va">posteam</span>, <span class="va">defteam</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### bringing in pre-aggregated next gen stats</span></span>
<span><span class="va">next_gen_stats</span> <span class="op">&lt;-</span> <span class="fu">nflreadr</span><span class="fu">::</span><span class="fu"><a href="https://nflreadr.nflverse.com/reference/load_nextgen_stats.html">load_nextgen_stats</a></span><span class="op">(</span>seasons <span class="op">=</span> <span class="fl">2016</span><span class="op">:</span><span class="fl">2022</span>, stat_type <span class="op">=</span> <span class="st">"rushing"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">week</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">season_type</span> <span class="op">==</span> <span class="st">"REG"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">season</span>, <span class="va">week</span>, <span class="va">player_gsis_id</span>,</span>
<span>         against_eight <span class="op">=</span> <span class="va">percent_attempts_gte_eight_defenders</span>, <span class="va">avg_time_to_los</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### merging in next gen stats</span></span>
<span><span class="va">rushing_data_join</span> <span class="op">&lt;-</span> <span class="va">rushing_data_join</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">next_gen_stats</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"season"</span>, <span class="st">"week"</span>, <span class="st">"rusher_player_id"</span> <span class="op">=</span> <span class="st">"player_gsis_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### placing offense personnel positions in individual columns</span></span>
<span><span class="co">### new column: extra_ol</span></span>
<span><span class="va">rushing_data_join</span> <span class="op">&lt;-</span> <span class="va">rushing_data_join</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    ol <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">offense_personnel</span>, <span class="st">"(?&lt;=\\s|^)\\d+(?=\\sOL)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    rb <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">offense_personnel</span>, <span class="st">"(?&lt;=\\s|^)\\d+(?=\\sRB)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    te <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">offense_personnel</span>, <span class="st">"(?&lt;=\\s|^)\\d+(?=\\sTE)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    wr <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">offense_personnel</span>, <span class="st">"(?&lt;=\\s|^)\\d+(?=\\sWR)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html">replace_na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>ol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>extra_ol <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">ol</span> <span class="op">&gt;</span> <span class="fl">5</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">ol</span><span class="op">:</span><span class="va">wr</span>, <span class="va">as.factor</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ol</span>, <span class="op">-</span><span class="va">offense_personnel</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### doing some as above but for defense personnel</span></span>
<span><span class="va">rushing_data_join</span> <span class="op">&lt;-</span> <span class="va">rushing_data_join</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dl <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">defense_personnel</span>, <span class="st">"(?&lt;=\\s|^)\\d+(?=\\sDL)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         lb <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">defense_personnel</span>, <span class="st">"(?&lt;=\\s|^)\\d+(?=\\sLB)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         db <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">defense_personnel</span>, <span class="st">"(?&lt;=\\s|^)\\d+(?=\\sLB)"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">dl</span><span class="op">:</span><span class="va">db</span>, <span class="va">as.factor</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">defense_personnel</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rushing_data_join</span> <span class="op">&lt;-</span> <span class="va">rushing_data_join</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">qtr</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co">### let's remove rushes that took place in OT</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>qtr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">qtr</span><span class="op">)</span>,</span>
<span>         down <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">down</span><span class="op">)</span>,</span>
<span>         shotgun <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">shotgun</span><span class="op">)</span>,</span>
<span>         no_huddle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">no_huddle</span><span class="op">)</span>,</span>
<span>         red_zone <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">red_zone</span><span class="op">)</span>,</span>
<span>         fg_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">fg_range</span><span class="op">)</span>,</span>
<span>         two_min_drill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">two_min_drill</span><span class="op">)</span>,</span>
<span>         extra_ol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">extra_ol</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### going to build model from rushes so will remove identifying information</span></span>
<span><span class="va">rushes</span> <span class="op">&lt;-</span> <span class="va">rushing_data_join</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">season</span>, <span class="op">-</span><span class="va">week</span>, <span class="op">-</span><span class="va">rusher</span>, <span class="op">-</span><span class="va">rusher_player_id</span>, <span class="op">-</span><span class="va">posteam</span>, <span class="op">-</span><span class="va">defteam</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.character</span><span class="op">)</span>, <span class="va">as.factor</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">rushes</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#################################</span></span>
<span><span class="co">## tidymodels work now</span></span>
<span><span class="co">################################</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1984</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">rushes</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rushing_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">rushes</span><span class="op">)</span></span>
<span><span class="va">rushing_train</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">rushing_split</span><span class="op">)</span></span>
<span><span class="va">rushing_test</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">rushing_split</span><span class="op">)</span></span>
<span><span class="va">rushing_folds</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">rushing_train</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### creating our xgboost recipe</span></span>
<span><span class="va">rushing_recipe</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">recipe</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">label</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">rushing_train</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_dummy</span><span class="op">(</span><span class="fu">all_nominal_predictors</span><span class="op">(</span><span class="op">)</span>, one_hot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### creating the model boosting tree specifications</span></span>
<span><span class="va">rushing_specs</span> <span class="op">&lt;-</span> <span class="fu">boost_tree</span><span class="op">(</span></span>
<span>  trees <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  tree_depth <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>  min_n <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  mtry <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  loss_reduction <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  sample_size <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  learn_rate <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  stop_iter <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"lightgbm"</span>, num_leaves <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### creating the tuning grid</span></span>
<span><span class="va">rushing_grid</span> <span class="op">&lt;-</span> <span class="fu">grid_latin_hypercube</span><span class="op">(</span></span>
<span>  <span class="fu">trees</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">tree_depth</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">finalize</span><span class="op">(</span><span class="fu">mtry</span><span class="op">(</span><span class="op">)</span>, <span class="va">rushes</span><span class="op">)</span>,</span>
<span>  <span class="fu">min_n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">num_leaves</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">loss_reduction</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  sample_size <span class="op">=</span> <span class="fu">sample_prop</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">learn_rate</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">stop_iter</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### adding everything into the workflow</span></span>
<span><span class="va">rushing_workflow</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">rushing_recipe</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">rushing_specs</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">registerDoSEQ</span><span class="op">(</span><span class="op">)</span> <span class="co">### to leave parallel processing</span></span>
<span><span class="fu">registerDoParallel</span><span class="op">(</span>cores <span class="op">=</span> <span class="fl">11</span><span class="op">)</span></span>
<span><span class="fu">doParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">stopImplicitCluster</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### tuning the grid with tictoc() running to see how long it takes</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rushing_tune</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://tune.tidymodels.org/reference/tune_grid.html">tune_grid</a></span><span class="op">(</span><span class="va">rushing_workflow</span>, resamples <span class="op">=</span> <span class="va">rushing_folds</span>, grid <span class="op">=</span> <span class="va">rushing_grid</span>, control <span class="op">=</span> <span class="fu"><a href="https://tune.tidymodels.org/reference/control_grid.html">control_grid</a></span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                                                                                     verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span> <span class="co">## 344.16 seconds/5 minutes (100 trees, 30 grid)</span></span>
<span>      <span class="co">## 5783.15 seconds/ 96 minutes (1000 trees, 60 grid)</span></span>
<span>      <span class="co">## 15643.44 seconds / 4.5 hours (tune() trees, 100 grid)</span></span>
<span></span>
<span><span class="co">### extracting the best performing hyperparameters from the tuning results</span></span>
<span><span class="va">best_params</span> <span class="op">&lt;-</span> <span class="va">rushing_tune</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tune.tidymodels.org/reference/show_best.html">select_best</a></span><span class="op">(</span>metric <span class="op">=</span> <span class="st">"rmse"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### creating a final workflow with this updated model specification</span></span>
<span><span class="va">rushing_final_workflow</span> <span class="op">&lt;-</span> <span class="va">rushing_workflow</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tune.tidymodels.org/reference/finalize_model.html">finalize_workflow</a></span><span class="op">(</span><span class="va">best_params</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### fitting the workflow on the testing data</span></span>
<span><span class="va">final_model</span> <span class="op">&lt;-</span> <span class="va">rushing_final_workflow</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">fit</span><span class="op">(</span>data <span class="op">=</span> <span class="va">rushing_test</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### using final mod to add the predictins to our prior rushing_data_join information</span></span>
<span><span class="va">rushing_predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">final_model</span>, <span class="va">rushing_data_join</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### creating our projections</span></span>
<span><span class="va">ryoe_projs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">rushing_data_join</span>, <span class="va">rushing_predictions</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>actual_yards <span class="op">=</span> <span class="va">label</span>,</span>
<span>         exp_yards <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### doing some math to find the league-wide average of mean_ryoe per season</span></span>
<span><span class="va">mean_ryoe</span> <span class="op">&lt;-</span> <span class="va">ryoe_projs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">season</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>nfl_mean_ryoe <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">actual_yards</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">exp_yards</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### merging in the mean_ryoe into the data per season</span></span>
<span><span class="va">ryoe_projs</span> <span class="op">&lt;-</span> <span class="va">ryoe_projs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">mean_ryoe</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"season"</span> <span class="op">=</span> <span class="st">"season"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### taking a player's actual yards minus his expected yards and then weighing it against NFL average per season</span></span>
<span><span class="va">ryoe_projs</span> <span class="op">&lt;-</span> <span class="va">ryoe_projs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ryoe <span class="op">=</span> <span class="va">actual_yards</span> <span class="op">-</span> <span class="va">exp_yards</span> <span class="op">+</span> <span class="va">nfl_mean_ryoe</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### outputting the results</span></span>
<span><span class="va">ryoe_projs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">rusher</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span></span>
<span>    rushes <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    yards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">actual_yards</span><span class="op">)</span>,</span>
<span>    exp_yards <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">exp_yards</span><span class="op">)</span>,</span>
<span>    ypc <span class="op">=</span> <span class="va">yards</span> <span class="op">/</span> <span class="va">rushes</span>,</span>
<span>    exp_ypc <span class="op">=</span> <span class="va">exp_yards</span> <span class="op">/</span> <span class="va">rushes</span>,</span>
<span>    avg_ryoe <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">ryoe</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">rushes</span> <span class="op">&gt;</span> <span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">avg_ryoe</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>fffff</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">for_plot</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">yards</span>, y <span class="op">=</span> <span class="va">exp_yards</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_poly_line</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">0</span>, </span>
<span>                 se <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                 linewidth <span class="op">=</span> <span class="fl">.8</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_poly_eq</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">0</span>,</span>
<span>               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html">after_stat</a></span><span class="op">(</span><span class="va">rr.label</span><span class="op">)</span>, </span>
<span>                   family <span class="op">=</span> <span class="st">"Roboto Condensed"</span>, </span>
<span>                   size <span class="op">=</span> <span class="fl">9</span>, fontface <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>               label.y <span class="op">=</span> <span class="fl">1</span>, label.x <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fl">21</span>, fill <span class="op">=</span> <span class="va">for_plot</span><span class="op">$</span><span class="va">team_color</span>, </span>
<span>             color <span class="op">=</span> <span class="va">for_plot</span><span class="op">$</span><span class="va">team_color2</span>, size <span class="op">=</span> <span class="va">for_plot</span><span class="op">$</span><span class="va">rushes</span> <span class="op">/</span> <span class="fl">200</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     label <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/pretty_breaks.html">pretty_breaks</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     label <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html">comma_format</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">nfl_analytics_theme</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Actual Rushing Yards"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Expected Rushing Yards"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Actual Rushing Yards vs. Expected Rushing Yards"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"2016 - 2022   |   Model: LightGBM"</span>,</span>
<span>       caption <span class="op">=</span> <span class="st">"An Introduction to NFL Analytics with R\nBrad J. Congelio"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text_repel</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">for_plot</span>, <span class="va">yards</span> <span class="op">&gt;=</span> <span class="fl">4500</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">rusher</span><span class="op">)</span>, box.padding <span class="op">=</span> <span class="fl">.8</span>, </span>
<span>                  point.padding <span class="op">=</span> <span class="fl">1</span>, family <span class="op">=</span> <span class="st">"Roboto Condensed"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="navigating-the-nfls-big-data-bowl" class="level2" data-number="6.8"><h2 data-number="6.8" class="anchored" data-anchor-id="navigating-the-nfls-big-data-bowl">
<span class="header-section-number">6.8</span> Navigating the NFL’s Big Data Bowl</h2>
<p>lots of place holding for Big Data Bowl material below</p>
<p>Thomas Bliss, a Data Scientist with the NFL, <a href="https://www.kaggle.com/competitions/nfl-big-data-bowl-2023/discussion/365497">provided an incredibly helpful list of potential topics</a> that can be explored using 2023 Big Data Bowl information:</p>
<ol type="1">
<li>analyze blocker positioning after the QB leaves the pocket and/or is pressured</li>
<li>analyze blocker ability to hold a defender in place without moving towards the QB</li>
<li>link the rate of false starts to an offensive line’s time off the snap</li>
<li>link between QB release time, receiver separation, and offensive line performance</li>
</ol>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### reading all weeks and writing to a parquet file</span></span>
<span><span class="va">all_bdb_weeks</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'core-data'</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">paths</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op">(</span><span class="va">dir</span>, regexp <span class="op">=</span> <span class="st">'week\\d+'</span><span class="op">)</span></span>
<span>  <span class="va">all_weeks</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">paths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html">map_df</a></span><span class="op">(</span><span class="fu">vroom</span><span class="fu">::</span><span class="va"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'core-data'</span>, <span class="st">'data.parquet'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">all_bdb_weeks</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### reading in all play information provided and writing to a parquet file</span></span>
<span><span class="va">read_bdb_plays</span> <span class="op">&lt;-</span> <span class="fu">memoise</span><span class="fu">::</span><span class="fu"><a href="https://memoise.r-lib.org/reference/memoise.html">memoise</a></span><span class="op">(</span><span class="op">{</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">plays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'core-data'</span>, <span class="st">'plays.csv'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'core-data'</span>, <span class="st">'plays.parquet'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">read_bdb_plays</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### reading in individual game information and writing to a parquet file</span></span>
<span><span class="va">read_game_info</span> <span class="op">&lt;-</span> <span class="fu">memoise</span><span class="fu">::</span><span class="fu"><a href="https://memoise.r-lib.org/reference/memoise.html">memoise</a></span><span class="op">(</span><span class="op">{</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'core-data'</span>, <span class="st">'games.csv'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span>game_date <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="va"><a href="https://lubridate.tidyverse.org/reference/ymd.html">mdy</a></span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/write_parquet.html">write_parquet</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">'core-data'</span>, <span class="st">'games.parquet'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### creating an individual .cvs file for each game in bdb</span></span>
<span><span class="va">all.weeks</span> <span class="op">&lt;-</span> <span class="fu">read_parquet</span><span class="op">(</span><span class="st">"./core-data/large-lfs-files/all-weeks-parquet"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all.weeks</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">game_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_walk</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'tracking_gameId_'</span>, <span class="va">.y</span><span class="op">$</span><span class="va">game_id</span>, <span class="st">".csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### writing in team colors, logos</span></span>
<span><span class="va">team.colors</span> <span class="op">&lt;-</span> <span class="fu">nflfastR</span><span class="fu">::</span><span class="va"><a href="https://www.nflfastr.com/reference/teams_colors_logos.html">teams_colors_logos</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">team_abbr</span>, <span class="va">team_color</span>, <span class="va">team_color2</span>, <span class="va">team_logo_espn</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>fffff</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rotate_the_dots</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="st">"play_direction"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Cannot find play directions. Inferring from offense and defense locations at snap."</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">event</span> <span class="op">==</span> <span class="st">"ball_snap"</span>, <span class="va">team</span> <span class="op">!=</span> <span class="st">"football"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">game_id</span>, <span class="va">play_id</span>, <span class="va">defensive_team</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">defensive_team</span>, values_from <span class="op">=</span> <span class="va">mean_x</span>, names_prefix <span class="op">=</span> <span class="st">"x_"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        play_direction <span class="op">=</span> </span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>            <span class="va">x_1</span> <span class="op">&gt;</span> <span class="va">x_0</span>,</span>
<span>            <span class="st">"right"</span>,</span>
<span>            <span class="st">"left"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">game_id</span>, <span class="va">play_id</span>, <span class="va">play_direction</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">df</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"game_id"</span>, <span class="st">"play_id"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>        </span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      to_left <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">play_direction</span> <span class="op">==</span> <span class="st">"left"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">to_left</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">120</span> <span class="op">-</span> <span class="va">x</span>, <span class="va">x</span><span class="op">)</span>,</span>
<span>      y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">to_left</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">160</span> <span class="op">/</span> <span class="fl">3</span> <span class="op">-</span> <span class="va">y</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>      los_x <span class="op">=</span> <span class="fl">100</span> <span class="op">-</span> <span class="va">absolute_yardline_number</span>,</span>
<span>      dist_from_los <span class="op">=</span> <span class="va">x</span> <span class="op">-</span> <span class="va">los_x</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="st">"o"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        o <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">to_left</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">o</span> <span class="op">+</span> <span class="fl">180</span>, <span class="va">o</span><span class="op">)</span>,</span>
<span>        o <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">o</span> <span class="op">&gt;</span> <span class="fl">360</span>, <span class="fl">0</span> <span class="op">-</span> <span class="fl">360</span>, <span class="va">o</span><span class="op">)</span>,</span>
<span>        o_rad <span class="op">=</span> <span class="va">pi</span> <span class="op">*</span> <span class="op">(</span><span class="va">o</span> <span class="op">/</span> <span class="fl">180</span><span class="op">)</span>,</span>
<span>        o_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">o</span><span class="op">)</span>, <span class="cn">NA_real_</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">o_rad</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        o_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">o</span><span class="op">)</span>, <span class="cn">NA_real_</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">o_rad</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="st">"dir"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">to_left</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">dir</span> <span class="op">+</span> <span class="fl">180</span>, <span class="va">dir</span><span class="op">)</span>,</span>
<span>        dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dir</span> <span class="op">&gt;</span> <span class="fl">360</span>, <span class="va">dir</span> <span class="op">-</span> <span class="fl">360</span>, <span class="va">dir</span><span class="op">)</span>,</span>
<span>        dir_rad <span class="op">=</span> <span class="va">pi</span> <span class="op">*</span> <span class="op">(</span><span class="va">dir</span> <span class="op">/</span> <span class="fl">180</span><span class="op">)</span>,</span>
<span>        dir_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span>, <span class="cn">NA_real_</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">dir_rad</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        dir_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span>, <span class="cn">NA_real_</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">dir_rad</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        s_x <span class="op">=</span> <span class="va">dir_x</span> <span class="op">*</span> <span class="va">s</span>,</span>
<span>        s_y <span class="op">=</span> <span class="va">dir_y</span> <span class="op">*</span> <span class="va">s</span>,</span>
<span>        a_x <span class="op">=</span> <span class="va">dir_x</span> <span class="op">*</span> <span class="va">a</span>,</span>
<span>        a_y <span class="op">=</span> <span class="va">dir_y</span> <span class="op">*</span> <span class="va">a</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>ffff</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">find_o_diff</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">prefix</span> <span class="op">=</span> <span class="st">"qb"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">name_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html">sym</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">prefix</span>, <span class="st">"_x"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">name_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html">sym</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">prefix</span>, <span class="st">"_y"</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">new_column</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"o_to_"</span>, <span class="va">prefix</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      dis_x <span class="op">=</span> <span class="op">{</span><span class="op">{</span><span class="va">name_x</span><span class="op">}</span><span class="op">}</span> <span class="op">-</span> <span class="va">x</span>,</span>
<span>      dis_y <span class="op">=</span> <span class="op">{</span><span class="op">{</span><span class="va">name_y</span><span class="op">}</span><span class="op">}</span> <span class="op">-</span> <span class="va">y</span>,</span>
<span>      </span>
<span>      tmp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">atan2</a></span><span class="op">(</span><span class="va">dis_y</span>, <span class="va">dis_x</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">180</span> <span class="op">/</span> <span class="va">pi</span><span class="op">)</span>,</span>
<span>      tmp <span class="op">=</span> <span class="op">(</span><span class="fl">360</span> <span class="op">-</span> <span class="va">tmp</span><span class="op">)</span> <span class="op">+</span> <span class="fl">90</span>,</span>
<span>      tmp <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">tmp</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="va">tmp</span> <span class="op">+</span> <span class="fl">360</span>,</span>
<span>                      <span class="va">tmp</span> <span class="op">&gt;</span> <span class="fl">360</span> <span class="op">~</span> <span class="va">tmp</span> <span class="op">-</span> <span class="fl">360</span>,</span>
<span>                      <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">tmp</span><span class="op">)</span>,</span>
<span>      </span>
<span>      diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">o</span> <span class="op">-</span> <span class="va">tmp</span><span class="op">)</span>,</span>
<span>      </span>
<span>      diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">o</span> <span class="op">-</span> <span class="va">tmp</span><span class="op">)</span>,</span>
<span>      </span>
<span>      <span class="op">!</span><span class="op">!</span><span class="va">new_column</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="fl">360</span> <span class="op">-</span> <span class="va">diff</span>, <span class="va">diff</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">diff</span>, <span class="op">-</span><span class="va">tmp</span><span class="op">)</span></span>
<span>      </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">########</span></span>
<span><span class="co">## READING IN PITTSBURGH VS. BUFFALO - WEEK 1</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">pitt.buff</span> <span class="op">&lt;-</span> <span class="fu">arrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/docs/r/reference/read_parquet.html">read_parquet</a></span><span class="op">(</span><span class="st">"core-data/large-lfs-files/all-weeks-parquet"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">game_id</span> <span class="op">==</span> <span class="st">"2021091201"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## READING IN PLAYS FROM PITTSBURGH VS. BUFFALO - WEEK 1</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">pitt.buff.plays</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"core-data/plays.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">game_id</span> <span class="op">==</span> <span class="st">"2021091201"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## READING IN GAME INFO FROM PITTSBURGH VS. BUFFALO - WEEK 1</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">pitt.buff.info</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"core-data/games.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">game_id</span> <span class="op">==</span> <span class="st">"2021091201"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## COMBING CORE GAME FILE WITH PLAYS, AND THEN BY INFO (TO AVOID MULTIPLE GAME_IDs IN DF)</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">complete.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">pitt.buff</span>, <span class="va">pitt.buff.plays</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"game_id"</span> <span class="op">=</span> <span class="st">"game_id"</span>, <span class="st">"play_id"</span> <span class="op">=</span> <span class="st">"play_id"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">complete.data</span> <span class="op">&lt;-</span> <span class="va">complete.data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">pitt.buff.info</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"game_id"</span> <span class="op">=</span> <span class="st">"game_id"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### ROTATING THE DOTS</span></span>
<span><span class="va">complete.data</span> <span class="op">&lt;-</span> <span class="fu">rotate_the_dots</span><span class="op">(</span><span class="va">complete.data</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## MUTATING TO CHARACTER VARIABLE DEFINING WHETHER TEAM IN FRAMES IS ON OFFENSE OR DEFENSE</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">complete.data</span> <span class="op">&lt;-</span> <span class="va">complete.data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>off_or_def <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">team</span> <span class="op">==</span> <span class="va">possession_team</span> <span class="op">~</span> <span class="st">"offense"</span>,</span>
<span>    <span class="va">team</span> <span class="op">!=</span> <span class="va">possession_team</span> <span class="op">~</span> <span class="st">"defense"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"football"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>            <span class="co">########</span></span>
<span>            <span class="co">## CORE CLEANING AND PREP IS COMPLETE</span></span>
<span>            <span class="co">########</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## ADDING IN INFORMATION FROM PLAYERS.CSV TO BUILD CHULLs FOR JUST O-LINE</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">player.info</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"core-data/players.csv"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">janitor</span><span class="fu">::</span><span class="fu"><a href="https://sfirke.github.io/janitor/reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">nfl_id</span>, <span class="va">official_position</span>, <span class="va">display_name</span><span class="op">)</span></span>
<span></span>
<span><span class="va">complete.data</span> <span class="op">&lt;-</span> <span class="va">complete.data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">player.info</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nfl_id"</span> <span class="op">=</span> <span class="st">"nfl_id"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## LET'S PICK OUT A FUN PLAY TO WORK WITH</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">one.play</span> <span class="op">&lt;-</span> <span class="va">complete.data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co">### BEN PASS TO EBRON FOR 19 YARDS</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">play_id</span> <span class="op">==</span> <span class="fl">2209</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## NOW LET'S BUILD A CONVEX HULL FOR JUST THE OFFENSIVE LINE</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">ol_chull_order</span> <span class="op">&lt;-</span> <span class="va">one.play</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">off_or_def</span> <span class="op">==</span> <span class="st">"offense"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">official_position</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"T"</span>, <span class="st">"C"</span>, <span class="st">"G"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="co">#### IMPORTANT TO KNOW PERSONNEL PACKAGE HERE: 0 RB, 0 TE, 5 WR</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">frame_id</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="va">chull</span></span>
<span></span>
<span><span class="va">ol_chull_order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ol_chull_order</span>, <span class="va">ol_chull_order</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ol_chull_coords</span> <span class="op">&lt;-</span> <span class="va">one.play</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">off_or_def</span> <span class="op">==</span> <span class="st">"offense"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">frame_id</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">ol_chull_order</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ol_chull_poly</span> <span class="op">&lt;-</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/SpatialPolygons.html">Polygon</a></span><span class="op">(</span><span class="va">ol_chull_coords</span>, hole <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">ol_chull_area</span> <span class="op">&lt;-</span> <span class="va">ol_chull_poly</span><span class="op">@</span><span class="va">area</span></span>
<span></span>
<span><span class="co">########</span></span>
<span><span class="co">## NOW LET'S PLOT IT</span></span>
<span><span class="co">########</span></span>
<span></span>
<span><span class="va">one.play</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">the_dots</span><span class="op">(</span></span>
<span>    animated <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    orientation <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    convex <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    segment_length <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    segment_size <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    dot_size <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    animated_h <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    animated_w <span class="op">=</span> <span class="fl">8</span>,</span>
<span>    animated_res <span class="op">=</span> <span class="fl">150</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography" style="display: none">
<div id="ref-nfelo" class="csl-entry" role="doc-biblioentry">
Greerre, Robby. 2022. <span>“Over Expected Metrics Explained – What Are CPOE, RYOE, and YACOE.”</span> <a href="https://www.nfeloapp.com/analysis/over-expected-explained-what-are-cpoe-ryoe-and-yacoe/">https://www.nfeloapp.com/analysis/over-expected-explained-what-are-cpoe-ryoe-and-yacoe/</a>.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>Thanks to Tej Seth for briefly chatting with me over Twitter regarding the history of both Michael’s RYOE model and his own.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./04-nfl-analytics-visualization.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Data Visualization with NFL Analytics</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">NFL Analytics with R was written by Bradley J. Congelio.</div>   
    <div class="nav-footer-right">This book was built with <a href="https://quarto.org/">Quarto</a></div>
  </div>
</footer>


</body></html>